<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JANPIRE — den förbannade tjärnen</title>
<meta name="theme-color" content="#0b0d10" />
<style>
  :root{
    --bg:#0b0d10; --bg2:#0f141b; --panel:#10141b; --ink:#0e141d;
    --text:#e8ecff; --sub:#cfd6ff; --muted:#8d97aa;
    --accent:#6cc0ff; --border:#1b2332;
    --ulv:#a82239; --by:#648066; --seer:#18a4c9; --hunt:#c49b32;
    --good:#58e1a3; --warn:#f7b955; --bad:#ff6b6b;
    --r:12px; --rsm:8px; --soft:0 10px 30px rgba(0,0,0,.4);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;color:var(--text);
    background:radial-gradient(1200px 700px at 20% -10%,#111725 0%,#0b0d10 60%) fixed;
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;
    letter-spacing:.2px;
  }
  h1,h2,h3{margin:0 0 8px}
  h1{font:700 22px/1.2 Georgia,serif;letter-spacing:.06em;text-transform:uppercase}
  h2{font:700 16px/1.2 Georgia,serif;letter-spacing:.06em;text-transform:uppercase;color:var(--sub)}
  h3{font:600 14px/1.2 Georgia,serif;letter-spacing:.05em;text-transform:uppercase;color:#b8c2ff}
  p{margin:0 0 10px;color:#c7cee0}
  header{
    position:sticky;top:0;z-index:5;backdrop-filter:saturate(115%) blur(6px);
    background:linear-gradient(180deg,rgba(10,14,19,.92),rgba(10,14,19,.65) 80%,transparent);
    border-bottom:1px solid var(--border)
  }
  .wrap{max-width:1200px;margin:0 auto;padding:12px 16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .grow{flex:1 1 auto}
  main{padding:14px 16px}
  .grid{display:grid;gap:14px}
  .two{grid-template-columns:1.1fr .9fr}
  @media (max-width:980px){.two{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,var(--panel),var(--bg2));border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--soft);padding:14px}
  .spot{box-shadow:0 0 0 1px rgba(108,192,255,.18), 0 12px 38px rgba(12,30,55,.55);border-color:#28354c}
  .divider{height:1px;background:var(--border);margin:10px 0}
  .tags{display:flex;gap:8px;flex-wrap:wrap}
  .tag{display:inline-flex;gap:8px;align-items:center;padding:5px 10px;border:1px solid var(--border);border-radius:999px;background:#0f1723;color:var(--muted);font-size:12px}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;padding:2px 6px;border-radius:6px;border:1px solid var(--border);background:#0e141d;color:#cfd8ff}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--ink);color:var(--text);outline:none}
  input:focus,select:focus,textarea:focus{box-shadow:0 0 0 3px rgba(108,192,255,.25)}
  textarea{min-height:110px;resize:vertical}
  .btn{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg,#1a2534,#111924);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;transition:.15s transform,.2s filter,.2s border-color;box-shadow:var(--soft)}
  .btn:active{transform:translateY(1px)} .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn.primary{border-color:#2a3242;background:linear-gradient(180deg,#1d2532,#141a24)}
  .btn.accent{border-color:#263d4b;background:linear-gradient(180deg,#173142,#0f202d)}
  .btn.good{border-color:#244238;background:linear-gradient(180deg,#123327,#0c241c)}
  .btn.warn{border-color:#403424;background:linear-gradient(180deg,#2f2915,#201c10)}
  .btn.bad{border-color:#402427;background:linear-gradient(180deg,#2f1518,#201014)}
  .btn.ghost{background:transparent}
  .list{display:flex;flex-direction:column;gap:8px}
  .li{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px;border:1px dashed var(--border);border-radius:10px;background:#0f151d}
  .portrait{display:flex;gap:10px;align-items:center}
  .avatar{width:34px;height:34px;border-radius:8px;background:linear-gradient(180deg,#1a2130,#0d111a);border:1px solid var(--border);position:relative;overflow:hidden}
  .avatar::after{content:"";position:absolute;inset:0;background:radial-gradient(24px 18px at 65% 35%, rgba(108,192,255,.18), transparent 60%)}
  .rolechip{padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#111827}
  .r-ulv{background:linear-gradient(180deg,#2a0f16,#17090c);border-color:#3e1b23;color:#ffb3bf}
  .r-by{background:linear-gradient(180deg,#0f1c15,#0a120d);border-color:#1f4031;color:#cfead9}
  .r-seer{background:linear-gradient(180deg,#0b1a20,#081116);border-color:#145064;color:#bfefff}
  .r-hunt{background:linear-gradient(180deg,#1b170b,#120f08);border-color:#463b1b;color:#ffe8a8}
  .dead{opacity:.45;text-decoration:line-through}
  .moon{display:inline-block;width:18px;height:18px;border-radius:50%;box-shadow:0 0 12px rgba(160,227,255,.35) inset;margin-right:8px;background:radial-gradient(10px 10px at 35% 35%, #e6f5ff 0%, #9dc9ff 45%, #3a5577 80%)}
  .fade-in{animation:fade .25s ease}@keyframes fade{from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none}}
  #toast{position:fixed;bottom:16px;right:16px;display:none;background:#0f1723;border:1px solid var(--border);border-radius:10px;padding:10px 12px;box-shadow:var(--soft)}
  #overlay{position:fixed;inset:0;background:rgba(4,7,12,.85);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:50}
  #overlay.show{display:flex}
  .overlay-card{width:min(720px,92vw);background:linear-gradient(180deg,#0f1520,#0a0f16);border:1px solid #28354c;border-radius:14px;padding:16px;box-shadow:0 0 0 1px rgba(108,192,255,.18), 0 12px 38px rgba(12,30,55,.55)}
  .steps{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .step{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0e1722;color:var(--muted);font-size:12px}
  .step.active{color:#d7e6ff;border-color:#2a3c57;box-shadow:0 0 0 2px rgba(108,192,255,.15) inset}
  dialog{border:1px solid var(--border);border-radius:12px;padding:14px;background:#0e141d;color:var(--text);box-shadow:var(--soft);max-width:460px}
  dialog::backdrop{background:rgba(2,6,12,.7)}
  .hint{color:var(--muted);font-size:13px}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div class="grow">
      <h1>JANPIRE — DEN FÖRBANNADE TJÄRNEN</h1>
      <div class="tags" style="margin-top:6px">
        <span class="tag" id="phase_tag">fas: natt</span>
        <span class="tag" id="scene_tag">scen: 1</span>
        <span class="tag" id="timer_tag">timer: 00:00</span>
        <span class="tag" id="gm_badge" style="display:none">GM MODE</span>
      </div>
    </div>
    <div class="row">
      <button class="btn accent" id="gm_toggle" data-matomo-name="gm-toggle" data-matomo-event="click" data-matomo-category="gm" data-matomo-action="toggle">gm-läge</button>
      <button class="btn" id="night_wizard">nattsekvens</button>
      <button class="btn ghost" id="reset_btn">nollställ</button>
    </div>
  </div>
</header>

<main class="wrap grid two" id="app_root">
  <!-- vänster: ritual flow -->
  <section class="card spot" id="left_flow">
    <h2>ritual flow</h2>
    <p class="hint">börja i gm-panelen till höger: lägg spelare → dela ut roller.</p>
    <div class="divider"></div>

    <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
      <section class="card">
        <h3>fas</h3>
        <div class="row" style="margin-top:6px">
          <button class="btn primary" id="btn_night">natt</button>
          <button class="btn" id="btn_day">dag</button>
        </div>
      </section>
      <section class="card">
        <h3>timer</h3>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="timer_start">start</button>
          <button class="btn" id="timer_stop">stopp</button>
          <button class="btn" id="timer_reset">återställ</button>
        </div>
      </section>
    </div>

    <div class="divider"></div>

    <section class="card scene-card fade-in">
      <h3><span class="moon"></span>scen <span id="scene_idx">1</span>: <span id="scene_title"></span></h3>
      <p id="scene_text" style="margin-top:6px"></p>
      <div class="row" style="margin-top:10px">
        <button class="btn good" id="scene_next" data-matomo-name="scene-next" data-matomo-event="click" data-matomo-category="scene" data-matomo-action="advance">nästa scen</button>
        <button class="btn warn" id="scene_repeat">repetera</button>
      </div>
    </section>

    <div class="divider"></div>

    <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
      <section class="card">
        <h3>röstning</h3>
        <div id="vote_tokens" class="tags" style="margin-top:6px"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" id="vote_add_from_players">lägg kandidat</button>
          <button class="btn warn" id="vote_clear">rensa</button>
          <button class="btn good" id="vote_result">visa resultat</button>
        </div>
      </section>
      <section class="card">
        <h3>anteckningar</h3>
        <textarea id="notes" rows="6" placeholder="misstankar, dödsordning, ledtrådar..."></textarea>
        <div class="row" style="margin-top:8px">
          <div class="grow hint">autosparas lokalt</div>
          <button class="btn ghost" id="notes_clear">töm</button>
        </div>
      </section>
    </div>
  </section>

  <!-- höger: gm arsenal -->
  <section class="card" id="gm_panel">
    <h2>gm arsenal</h2>
    <div class="divider"></div>

    <section class="card">
      <h3>snabbstart</h3>
      <div class="row">
        <button class="btn good" id="seed_demo" data-matomo-name="seed-demo" data-matomo-event="click" data-matomo-category="gm">ladda demo</button>
        <button class="btn" id="export_btn">export json</button>
        <label class="btn ghost" for="import_file" style="cursor:pointer">import json</label>
        <input id="import_file" type="file" accept="application/json" style="display:none" />
      </div>
      <p class="hint" style="margin-top:6px">demo skapar 8 spelare + balanserade roller + ställer scen 1.</p>
    </section>

    <section class="card">
      <h3>spelare</h3>
      <div class="list" id="players_list"></div>
      <div class="row" style="margin-top:8px">
        <input id="player_name" placeholder="ny spelare (namn)" />
        <button class="btn primary" id="player_add" data-matomo-name="player-add" data-matomo-event="click" data-matomo-category="players">lägg till</button>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="player_bulk" placeholder="snabbadd: namn kommaseparerade (t.ex. alva, johan, my)" />
        <button class="btn" id="player_bulk_add">lägg flera</button>
      </div>
    </section>

    <section class="card">
      <h3>roller</h3>
      <div class="tags" id="roles_chips"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn good" id="assign_roles">dela ut roller</button>
        <button class="btn warn" id="clear_roles">rensa roller</button>
      </div>
      <div class="divider"></div>
      <h3>skapa egen roll</h3>
      <div class="row">
        <input id="role_name" placeholder="rollnamn (t.ex. Häxa)" />
        <select id="role_team" style="max-width:160px">
          <option value="by">by</option>
          <option value="ulv">ulv</option>
        </select>
      </div>
      <textarea id="role_secret" placeholder="hemlig kraft / instruktion (visas bara för gm)"></textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="role_add">lägg till roll</button>
        <button class="btn bad" id="role_remove_last">ta bort senaste egna roll</button>
      </div>
      <p class="hint">grundrollerna (varulv, sierska, jägare, bybo) kan inte tas bort, men du kan lägga till egna.</p>
    </section>

    <section class="card">
      <h3>scener</h3>
      <div class="list" id="scenes_list"></div>
      <div class="row" style="margin-top:8px">
        <input id="scene_custom" placeholder="snabb scen — rubrik :: text" />
        <button class="btn" id="scene_add_quick">lägg till</button>
      </div>
    </section>

    <section class="card">
      <h3>inställningar</h3>
      <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label class="hint">gm-pin</label>
          <input id="pin_input" value="1349"/>
        </div>
        <div>
          <label class="hint">återställ allt</label><br/>
          <button class="btn bad" id="hard_reset">rensa localStorage</button>
        </div>
      </div>
    </section>
  </section>
</main>

<!-- kandidatväljare -->
<dialog id="candidate_modal">
  <h3>lägg kandidat</h3>
  <p class="hint" style="margin-bottom:8px">välj en levande spelare</p>
  <select id="candidate_select"></select>
  <div class="row" style="margin-top:10px;justify-content:flex-end">
    <button class="btn ghost" id="candidate_cancel">avbryt</button>
    <button class="btn primary" id="candidate_ok">lägg till</button>
  </div>
</dialog>

<!-- nattsekvens -->
<div id="overlay" aria-hidden="true">
  <div class="overlay-card">
    <h2>nattens ritual</h2>
    <div class="steps" id="steps_row"></div>
    <div class="card" id="step_body" style="margin-top:8px;min-height:88px"></div>
    <div class="row" style="margin-top:10px;justify-content:flex-end">
      <button class="btn ghost" id="overlay_close">stäng</button>
      <button class="btn primary" id="overlay_prev">tillbaka</button>
      <button class="btn good" id="overlay_next">nästa</button>
    </div>
  </div>
</div>

<div id="toast" role="status" aria-live="polite"></div>

<footer class="wrap" style="opacity:.7;font-size:12px;padding:16px">
  tips: <span class="kbd">n</span> natt, <span class="kbd">d</span> dag, <span class="kbd">space</span> start/stopp timer. export finns i gm-panelen.
</footer>

<script>
/* ========= default data ========= */
const coreRoles = [
  { id:"varulv", name:"Varulv", team:"ulv", secret:"Du jagar om natten. Peka diskret på ett offer när GM ber." },
  { id:"sierska", name:"Sierska", team:"by", secret:"Varje natt kan du undersöka en spelare (ulv eller inte)." },
  { id:"jägare", name:"Jägare", team:"by", secret:"Om du dör får du ta med dig någon." },
  { id:"bybo",  name:"Bybo",  team:"by",  secret:"Ingen kraft. Din styrka är din röst." }
];
const defaultData = {
  story:{
    title:"Skuggor över Vargtjärn",
    scenes:[
      { title:"ankomst", text:"Dimman ligger lågt över tjärnen. Ett avlägset yl bryter tystnaden." },
      { title:"värdshuset", text:"Anslagstavlan: försvinnanden. Viskningar om en förbannelse." },
      { title:"spåren", text:"Klösmärken i skogsbrynet… och märken av bojor." },
      { title:"gammelstugan", text:"Dagboken nämner måndatum och ett namn. Någon döljer sanningen." },
      { title:"uppgörelsen", text:"Mörkret sänker sig. Byn samlas vid tjärnen för sanningen." }
    ]
  },
  roles:[...coreRoles]
};

/* ========= state ========= */
const state = {
  pin:"1349",
  phase:"natt",
  timer:0, timerHandle:null,
  sceneIndex:0,
  players:[],        // {name, roleId?, alive:true}
  votes:{},          // name -> count
  notes:"",
  data: JSON.parse(localStorage.getItem("janpire_data") || JSON.stringify(defaultData))
};

/* ========= dom helpers ========= */
const $=s=>document.querySelector(s);
const el=(t,a={},c=[])=>{const n=document.createElement(t);for(const[k,v]of Object.entries(a)){if(k==="class")n.className=v;else if(k==="text")n.textContent=v;else if(k.startsWith("on"))n.addEventListener(k.slice(2),v);else n.setAttribute(k,v)}c.forEach(x=>n.appendChild(typeof x==="string"?document.createTextNode(x):x));return n};
const toast=msg=>{const t=$("#toast");t.textContent=msg;t.style.display="block";setTimeout(()=>t.style.display="none",1700)};
const save=()=>{localStorage.setItem("janpire_state",JSON.stringify({phase:state.phase,timer:state.timer,sceneIndex:state.sceneIndex,players:state.players,votes:state.votes,notes:state.notes}));localStorage.setItem("janpire_data",JSON.stringify(state.data))};
const load=()=>{const raw=localStorage.getItem("janpire_state");if(!raw)return;try{Object.assign(state,JSON.parse(raw))}catch(e){console.warn(e)}};
const fmt=n=>String(n).padStart(2,"0");

/* ========= render ========= */
function roleClassName(r){ if(r.id==="varulv")return"r-ulv"; if(r.id==="sierska")return"r-seer"; if(r.id==="jägare")return"r-hunt"; return"r-by" }

function renderAll(){
  $("#phase_tag").textContent="fas: "+state.phase;
  $("#scene_tag").textContent="scen: "+(state.sceneIndex+1);
  $("#scene_idx").textContent=(state.sceneIndex+1);
  const sc=state.data.story.scenes[state.sceneIndex]||{title:"—",text:"—"};
  $("#scene_title").textContent=sc.title; $("#scene_text").textContent=sc.text;

  // players
  const plist=$("#players_list"); plist.innerHTML="";
  state.players.forEach((p,i)=>{
    const role=state.data.roles.find(r=>r.id===p.roleId); const rc=role?roleClassName(role):"";
    const rn=role?role.name:"—"; const dead=(p.alive===false)?"dead":"";
    plist.appendChild(el("div",{class:"li "+dead},[
      el("div",{class:"portrait"},[el("div",{class:"avatar"}), el("div",{},[el("div",{text:p.name}), el("div",{class:"hint",text:(p.alive===false?"ute":"levande")+" • "+rn})])]),
      el("div",{},[
        el("span",{class:"rolechip "+rc,text:rn}),
        el("button",{class:"btn",text:"hemligt",onclick:()=>revealSecret(p)}),
        el("button",{class:"btn warn",text:(p.alive===false?"markera levande":"markera ute"),onclick:()=>toggleAlive(i)}),
        el("button",{class:"btn ghost",text:"ta bort",onclick:()=>removePlayer(i)})
      ])
    ]));
  });

  // roles chips
  const rchips=$("#roles_chips"); rchips.innerHTML="";
  state.data.roles.forEach(r=>rchips.appendChild(el("span",{class:"tag rolechip "+roleClassName(r),title:r.secret,text:r.name})));

  // scenes list
  const sl=$("#scenes_list"); sl.innerHTML="";
  state.data.story.scenes.forEach((s,idx)=>{
    sl.appendChild(el("div",{class:"li"},[
      el("div",{},[el("div",{text:`${idx+1}. ${s.title}`}), el("div",{class:"hint",text:s.text})]),
      el("div",{},[el("button",{class:"btn",text:"gå hit",onclick:()=>{state.sceneIndex=idx;save();renderAll();}})])
    ]))
  });

  // votes
  renderVotes();

  // enable/disable buttons based on state
  $("#assign_roles").disabled = state.players.length===0;
}

function renderVotes(){
  const box=$("#vote_tokens"); box.innerHTML="";
  const items=Object.entries(state.votes).sort((a,b)=>b[1]-a[1]); const max=items[0]?.[1]??0;
  items.forEach(([name,count])=>{
    const top=count===max && count>0 ? "spot" : "";
    const chip=el("span",{class:"tag "+top},[el("strong",{text:name}),document.createTextNode(" • "),el("span",{text:count})]);
    const plus=el("button",{class:"btn",text:"+",onclick:()=>vote(name)});
    const minus=el("button",{class:"btn warn",text:"−",onclick:()=>unvote(name)});
    const rm=el("button",{class:"btn ghost",text:"x",onclick:()=>removeVote(name)});
    box.appendChild(el("div",{class:"row"},[chip,plus,minus,rm]));
  });
}

function revealSecret(p){
  const role=state.data.roles.find(r=>r.id===p.roleId);
  const txt=role?`roll: ${role.name}\nlag: ${role.team}\n\nhemligt:\n${role.secret}`:"ingen roll utdelad än.";
  alert(`${p.name}\n\n${txt}`);
}

/* ========= actions ========= */
// players
function addPlayer(){
  const name=$("#player_name").value.trim();
  if(!name){ toast("ange namn"); return; }
  if(state.players.some(p=>p.name.toLowerCase()===name.toLowerCase())){ toast("namn redan tillagt"); return; }
  state.players.push({name,alive:true}); $("#player_name").value="";
  save(); renderAll(); toast("spelare tillagd");
}
function addPlayersBulk(){
  const raw=$("#player_bulk").value.trim(); if(!raw){ toast("inga namn"); return; }
  const names=[...new Set(raw.split(",").map(s=>s.trim()).filter(Boolean))];
  if(names.length===0){ toast("inga giltiga namn"); return; }
  let added=0; names.forEach(n=>{ if(!state.players.some(p=>p.name.toLowerCase()===n.toLowerCase())){ state.players.push({name:n,alive:true}); added++; }});
  $("#player_bulk").value=""; save(); renderAll(); toast(`tillagda: ${added}`);
}
function removePlayer(i){ state.players.splice(i,1); save(); renderAll(); }
function toggleAlive(i){ state.players[i].alive = !(state.players[i].alive===false); save(); renderAll(); }

// roles
function assignRoles(){
  if(state.players.length===0){ toast("lägg spelare först"); return; }
  const haveVarulv=state.data.roles.some(r=>r.id==="varulv");
  const haveSeer  =state.data.roles.some(r=>r.id==="sierska");
  const haveHunt  =state.data.roles.some(r=>r.id==="jägare");
  const pool=[];
  const wolves=Math.max(1,Math.floor(state.players.length/5));
  if(haveVarulv) for(let i=0;i<wolves;i++) pool.push("varulv");
  if(haveSeer) pool.push("sierska");
  if(haveHunt) pool.push("jägare");
  while(pool.length<state.players.length) pool.push("bybo");
  shuffle(pool);
  state.players = state.players.map((p,i)=>({...p,roleId: pool[i]}));
  save(); renderAll(); toast("roller utdelade");
}
function clearRoles(){ state.players = state.players.map(p=>({...p,roleId:undefined})); save(); renderAll(); toast("roller rensade"); }

function addCustomRole(){
  const name=$("#role_name").value.trim(); const team=$("#role_team").value;
  const secret=$("#role_secret").value.trim();
  if(!name){ toast("ange rollnamn"); return; }
  const id=slugify(name);
  if(state.data.roles.some(r=>r.id===id)){ toast("rollen finns redan"); return; }
  state.data.roles.push({id,name,team,secret:secret||"—"});
  $("#role_name").value=""; $("#role_secret").value="";
  save(); renderAll(); toast("roll tillagd");
}
function removeLastCustomRole(){
  for(let i=state.data.roles.length-1;i>=0;i--){
    const id=state.data.roles[i].id;
    if(!coreRoles.find(cr=>cr.id===id)){ state.data.roles.splice(i,1); save(); renderAll(); toast("senaste egna roll borttagen"); return; }
  }
  toast("inga egna roller att ta bort");
}

// scenes
function nextScene(){ state.sceneIndex=Math.min(state.sceneIndex+1,state.data.story.scenes.length-1); save(); renderAll(); }
function repeatScene(){ renderAll(); toast("scen repeterad"); }
function addCustomScene(){
  const raw=$("#scene_custom").value.trim(); if(!raw){ toast("ange rubrik :: text"); return; }
  const [title,...rest]=raw.split("::"); const text=(rest.join("::")||"—").trim();
  state.data.story.scenes.push({title:title.trim(),text}); $("#scene_custom").value="";
  save(); renderAll(); toast("scen tillagd");
}

// votes
function vote(name){ state.votes[name]=(state.votes[name]||0)+1; save(); renderVotes(); }
function unvote(name){ if(!state.votes[name])return; state.votes[name]=Math.max(0,state.votes[name]-1); if(state.votes[name]===0) delete state.votes[name]; save(); renderVotes(); }
function removeVote(name){ delete state.votes[name]; save(); renderVotes(); }
function clearVotes(){ state.votes={}; save(); renderVotes(); toast("röster rensade"); }
function openCandidatePicker(){
  const sel=$("#candidate_select"); sel.innerHTML="";
  const live=state.players.filter(p=>p.alive!==false);
  if(live.length===0){ toast("inga levande spelare"); return; }
  live.forEach(p=>sel.appendChild(el("option",{value:p.name,text:p.name})));
  $("#candidate_modal").showModal();
}
$("#candidate_cancel").addEventListener("click",()=>$("#candidate_modal").close());
$("#candidate_ok").addEventListener("click",()=>{ const n=$("#candidate_select").value; if(n){ state.votes[n]=(state.votes[n]||0); save(); renderVotes(); } $("#candidate_modal").close(); });
function showVoteResult(){
  const e=Object.entries(state.votes); if(e.length===0){ toast("inga röster"); return; }
  const s=e.sort((a,b)=>b[1]-a[1]); const top=s[0][1]; const winners=s.filter(([,c])=>c===top).map(([n])=>n);
  alert(`flest röster: ${winners.join(", ")} (${top})`);
}

/* ========= phase & timer ========= */
function setPhase(p){ state.phase=p; $("#btn_night").classList.toggle("primary",p==="natt"); $("#btn_day").classList.toggle("primary",p==="dag"); save(); renderAll(); }
function tick(){ state.timer++; const m=Math.floor(state.timer/60),s=state.timer%60; $("#timer_tag").textContent=`timer: ${fmt(m)}:${fmt(s)}` }
function timerStart(){ if(state.timerHandle) return; state.timerHandle=setInterval(tick,1000) }
function timerStop(){ clearInterval(state.timerHandle); state.timerHandle=null }
function timerReset(){ state.timer=0; $("#timer_tag").textContent="timer: 00:00" }

/* ========= gm toggle & safety ========= */
let gmOpen=false;
function openGM(){ gmOpen=true; $("#gm_panel").style.display="block"; $("#gm_badge").style.display="inline-flex" }
function closeGM(){ gmOpen=false; $("#gm_panel").style.display="none"; $("#gm_badge").style.display="none" }
function toggleGM(){
  if(gmOpen){ closeGM(); return; }
  const pin=prompt("ange gm-pin"); if(pin===state.pin){ openGM(); } else { toast("fel pin") }
}

/* ========= seed / import / export ========= */
function seedDemo(){
  state.players = ["Alva","Johan","My","Leo","Sara","Mika","Noah","Ines"].map(n=>({name:n,alive:true}));
  // balansera roller
  const wolves=Math.max(1,Math.floor(state.players.length/5)); const pool=[];
  for(let i=0;i<wolves;i++) pool.push("varulv"); pool.push("sierska"); pool.push("jägare");
  while(pool.length<state.players.length) pool.push("bybo");
  shuffle(pool); state.players = state.players.map((p,i)=>({...p,roleId:pool[i]}));
  state.sceneIndex=0; state.phase="natt"; timerReset();
  save(); renderAll(); toast("demo laddad");
}
function exportJson(){
  const payload={state:{phase:state.phase,sceneIndex:state.sceneIndex,players:state.players,votes:state.votes,notes:state.notes}, data:state.data};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`janpire_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href);
}
function importJson(file){
  const r=new FileReader();
  r.onload=()=>{ try{
      const obj=JSON.parse(r.result);
      if(obj.data?.roles && obj.state?.players!==undefined){
        Object.assign(state,{...state,...obj.state}); state.data=obj.data; save(); renderAll(); toast("import ok");
      } else { toast("ogiltig json") }
    }catch{ toast("kunde inte läsa json") } };
  r.readAsText(file);
}

/* ========= night wizard ========= */
const steps=[
  {id:"blind", title:"alla blundar", body:"Alla blundar. Tystnad faller över byn."},
  {id:"wolves", title:"varulvarna vaknar", body:"Varulvarna öppnar ögonen och pekar ut ett offer. Bekräfta när du sett."},
  {id:"seer", title:"sierskan vaknar", body:"Sierskan pekar på en spelare. Viskande: “ulv” eller “inte ulv”."},
  {id:"others", title:"andra effekter", body:"Andra roller (om du lagt till dem) aktiveras."},
  {id:"dawn", title:"gryning", body:"Avslöja nattens konsekvenser. Byt fas till dag."}
];
let stepIdx=0;
function openWizard(){ stepIdx=0; renderWizard(); $("#overlay").classList.add("show"); $("#overlay").setAttribute("aria-hidden","false") }
function closeWizard(){ $("#overlay").classList.remove("show"); $("#overlay").setAttribute("aria-hidden","true") }
function renderWizard(){
  const row=$("#steps_row"); row.innerHTML="";
  steps.forEach((s,i)=>row.appendChild(el("span",{class:"step "+(i===stepIdx?"active":""),text:`${i+1}. ${s.title.toUpperCase()}`})));
  $("#step_body").innerHTML=`<p>${steps[stepIdx].body}</p>`;
  $("#overlay_prev").disabled = (stepIdx===0);
  $("#overlay_next").textContent = stepIdx===steps.length-1 ? "avsluta" : "nästa";
}

/* ========= utils ========= */
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a }
function slugify(s){ return s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"") }

/* ========= bind ========= */
function bind(){
  // phase & timer
  $("#btn_night").addEventListener("click",()=>setPhase("natt"));
  $("#btn_day").addEventListener("click",()=>setPhase("dag"));
  $("#timer_start").addEventListener("click",timerStart);
  $("#timer_stop").addEventListener("click",timerStop);
  $("#timer_reset").addEventListener("click",timerReset);

  // scenes
  $("#scene_next").addEventListener("click",nextScene);
  $("#scene_repeat").addEventListener("click",repeatScene);
  $("#scene_add_quick").addEventListener("click",addCustomScene);

  // votes
  $("#vote_add_from_players").addEventListener("click",openCandidatePicker);
  $("#vote_clear").addEventListener("click",clearVotes);
  $("#vote_result").addEventListener("click",showVoteResult);

  // notes
  $("#notes").addEventListener("input",e=>{state.notes=e.target.value;save()});
  $("#notes_clear").addEventListener("click",()=>{$("#notes").value="";state.notes="";save()});

  // gm & settings
  $("#gm_toggle").addEventListener("click",toggleGM);
  $("#pin_input").addEventListener("change",e=>{state.pin=e.target.value.trim();toast("pin uppdaterad")});
  $("#hard_reset").addEventListener("click",()=>{ if(confirm("rensa allt och börja om?")){ localStorage.removeItem("janpire_state"); localStorage.removeItem("janpire_data"); location.reload(); }});
  $("#reset_btn").addEventListener("click",()=>{ if(confirm("nollställ spel (behåller story/roller)?")){ localStorage.removeItem("janpire_state"); location.reload(); }});

  // players
  $("#player_add").addEventListener("click",addPlayer);
  $("#player_bulk_add").addEventListener("click",addPlayersBulk);

  // roles
  $("#assign_roles").addEventListener("click",assignRoles);
  $("#clear_roles").addEventListener("click",clearRoles);
  $("#role_add").addEventListener("click",addCustomRole);
  $("#role_remove_last").addEventListener("click",removeLastCustomRole);

  // seed / import / export
  $("#seed_demo").addEventListener("click",seedDemo);
  $("#export_btn").addEventListener("click",exportJson);
  $("#import_file").addEventListener("change",e=>{ const f=e.target.files?.[0]; if(f) importJson(f) });

  // overlay
  $("#night_wizard").addEventListener("click",openWizard);
  $("#overlay_close").addEventListener("click",closeWizard);
  $("#overlay_prev").addEventListener("click",()=>{ if(stepIdx>0){ stepIdx--; renderWizard(); }});
  $("#overlay_next").addEventListener("click",()=>{ if(stepIdx<steps.length-1){ stepIdx++; renderWizard(); } else { closeWizard(); setPhase("dag"); } });

  // keyboard
  document.addEventListener("keydown",e=>{
    if(e.key==="n") setPhase("natt");
    if(e.key==="d") setPhase("dag");
    if(e.key===" "){ e.preventDefault(); state.timerHandle?timerStop():timerStart(); }
  });
}

/* ========= boot ========= */
load();
if(state.sceneIndex>=state.data.story.scenes.length) state.sceneIndex=0;
renderAll(); bind();
// öppna gm-läge direkt första gången för att undvika “kan ej lägga till”
if(!localStorage.getItem("janpire_booted")){ openGM(); localStorage.setItem("janpire_booted","1"); }
window.__janpire={state,save,renderAll};
</script>
</body>
</html>