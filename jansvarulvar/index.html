<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JANPIRE — den förbannade tjärnen</title>
  <meta name="theme-color" content="#0b0d10" />
  <style>
    /* ===== design tokens ===== */
    :root{
      --bg:#0b0d10; --bg2:#0f141b; --panel:#10141b; --panel-hi:#121826;
      --ink:#0e141d; --muted:#8d97aa; --text:#e8ecff; --sub:#cfd6ff;
      --accent:#6cc0ff; --accent-2:#a0e3ff;
      --ulv:#a82239; --by:#648066; --seer:#18a4c9; --hunter:#c49b32;
      --good:#58e1a3; --warn:#f7b955; --bad:#ff6b6b;
      --border:#1b2332; --glow:0 0 0 1px rgba(108,192,255,.18), 0 12px 38px rgba(12,30,55,.55);
      --soft:0 10px 30px rgba(0,0,0,.4);
      --radius:12px; --r-sm:8px;
    }

    /* ===== base ===== */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%,#111725 0%,#0b0d10 60%) fixed,
        linear-gradient(180deg,#0b0d10 0%, #0b0d10 100%) fixed;
      font:16px/1.55 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
      letter-spacing:.2px;
    }
    h1,h2,h3{margin:0 0 8px}
    h1{font:700 22px/1.2 Georgia, "Times New Roman", serif; letter-spacing:.06em; text-transform:uppercase}
    h2{font:700 16px/1.2 Georgia, "Times New Roman", serif; letter-spacing:.06em; text-transform:uppercase; color:var(--sub)}
    h3{font:600 14px/1.2 Georgia, "Times New Roman", serif; letter-spacing:.05em; text-transform:uppercase; color:#b8c2ff}
    p{margin:0 0 10px; color:#c8cee0}
    a{color:var(--accent); text-decoration:none}

    /* ===== layout ===== */
    header{
      position:sticky; top:0; z-index:5;
      background:linear-gradient(180deg, rgba(10,14,19,.92), rgba(10,14,19,.65) 80%, transparent);
      border-bottom:1px solid var(--border);
      backdrop-filter:saturate(115%) blur(6px);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:12px 16px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .grow{flex:1 1 auto}

    main{padding:14px 16px}
    .grid{display:grid; gap:14px}
    .two{grid-template-columns: 1.1fr .9fr}
    @media (max-width: 980px){ .two{grid-template-columns:1fr} }

    section.card{
      background:linear-gradient(180deg,var(--panel),var(--bg2));
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--soft); padding:14px;
    }
    .panel-spot{box-shadow:var(--glow); border-color:#28354c}
    .divider{height:1px; background:var(--border); margin:10px 0}

    /* ===== chips, buttons, inputs ===== */
    .tags{display:flex; gap:8px; flex-wrap:wrap}
    .tag{display:inline-flex; align-items:center; gap:8px; padding:5px 10px; border:1px solid var(--border);
      border-radius:999px; background:linear-gradient(180deg,#101722,#0b1016); color:var(--muted); font-size:12px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px; padding:2px 6px; border-radius:6px; border:1px solid var(--border); background:#0e141d; color:#cfd8ff}

    input,select,textarea{
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid var(--border); background:var(--ink); color:var(--text); outline:none;
    }
    input:focus,select:focus,textarea:focus{box-shadow:0 0 0 3px rgba(108,192,255,.25)}
    textarea{min-height:120px; resize:vertical}

    .btn{
      appearance:none; border:1px solid var(--border);
      background:linear-gradient(180deg,#1a2534,#111924);
      color:var(--text); padding:10px 14px; border-radius:10px; cursor:pointer;
      transition:.15s transform ease,.2s filter ease,.2s border-color ease;
      box-shadow:var(--soft);
    }
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.55; cursor:not-allowed}
    .btn.primary{border-color:#2a3242; background:linear-gradient(180deg,#1d2532,#141a24)}
    .btn.accent{border-color:#263d4b; background:linear-gradient(180deg,#173142,#0f202d)}
    .btn.good{border-color:#244238; background:linear-gradient(180deg,#123327,#0c241c)}
    .btn.warn{border-color:#403424; background:linear-gradient(180deg,#2f2915,#201c10)}
    .btn.bad{border-color:#402427; background:linear-gradient(180deg,#2f1518,#201014)}
    .btn.ghost{background:transparent}

    /* ===== lists ===== */
    .list{display:flex; flex-direction:column; gap:8px}
    .li{display:flex; gap:10px; align-items:center; justify-content:space-between; padding:10px; border:1px dashed var(--border); border-radius:10px; background:#0f151d}

    /* ===== portraits / players ===== */
    .portrait{display:flex; gap:10px; align-items:center}
    .avatar{
      width:34px; height:34px; border-radius:8px; background:linear-gradient(180deg,#1a2130,#0d111a); border:1px solid var(--border);
      position:relative; overflow:hidden;
    }
    .avatar::after{content:""; position:absolute; inset:0; background:
      radial-gradient(24px 18px at 65% 35%, rgba(108,192,255,.18), transparent 60%);}
    .rolechip{padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:#111827}
    .r-ulv{background:linear-gradient(180deg,#2a0f16,#17090c); border-color:#3e1b23; color:#ffb3bf}
    .r-by{background:linear-gradient(180deg,#0f1c15,#0a120d); border-color:#1f4031; color:#cfead9}
    .r-seer{background:linear-gradient(180deg,#0b1a20,#081116); border-color:#145064; color:#bfefff}
    .r-hunt{background:linear-gradient(180deg,#1b170b,#120f08); border-color:#463b1b; color:#ffe8a8}
    .dead{opacity:.45; text-decoration:line-through}

    /* ===== scene card ===== */
    .scene-card h3{font-size:18px}
    .moon{display:inline-block; width:18px; height:18px; border-radius:50%; box-shadow:0 0 12px rgba(160,227,255,.35) inset; margin-right:8px;
      background:radial-gradient(10px 10px at 35% 35%, #e6f5ff 0%, #9dc9ff 45%, #3a5577 80%);}
    .fade-in{animation:fade .25s ease}
    @keyframes fade{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}

    /* ===== toast ===== */
    #toast{position:fixed; bottom:16px; right:16px; display:none; background:#0f1723; border:1px solid var(--border);
      border-radius:10px; padding:10px 12px; box-shadow:var(--soft)}

    /* ===== gm highlight ===== */
    #gm_badge{border:1px solid #3a1f28; color:#f0c8d2; background:linear-gradient(180deg,#1c0f14,#140a0d)}
    .gm-ring{box-shadow:0 0 0 1px rgba(255,107,107,.25), 0 0 0 4px rgba(255,107,107,.08)}

    /* ===== overlay: night stepper ===== */
    #overlay{
      position:fixed; inset:0; background:rgba(4,7,12,.85); backdrop-filter:blur(4px);
      display:none; align-items:center; justify-content:center; z-index:50;
    }
    #overlay.show{display:flex}
    .overlay-card{
      width:min(720px,92vw); background:linear-gradient(180deg,#0f1520,#0a0f16);
      border:1px solid #28354c; border-radius:14px; padding:16px; box-shadow:var(--glow)
    }
    .steps{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
    .step{padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#0e1722; color:var(--muted); font-size:12px}
    .step.active{color:#d7e6ff; border-color:#2a3c57; box-shadow:0 0 0 2px rgba(108,192,255,.15) inset}

    /* ===== modal candidate picker ===== */
    dialog{
      border:1px solid var(--border); border-radius:12px; padding:14px; background:#0e141d; color:var(--text); box-shadow:var(--soft);
      max-width:420px;
    }
    dialog::backdrop{background:rgba(2,6,12,.7)}
  </style>
</head>
<body>
  <!-- header -->
  <header>
    <div class="wrap row">
      <div class="grow">
        <h1>JANPIRE — DEN FÖRBANNADE TJÄRNEN</h1>
        <div class="tags" style="margin-top:6px">
          <span class="tag" id="phase_tag">fas: natt</span>
          <span class="tag" id="scene_tag">scen: 1</span>
          <span class="tag" id="timer_tag">timer: 00:00</span>
        </div>
      </div>
      <div class="row">
        <button class="btn accent" id="gm_toggle" title="öppna gm-läge"
          data-matomo-name="gm-toggle" data-matomo-event="click" data-matomo-category="gm" data-matomo-action="toggle">gm-läge</button>
        <button class="btn" id="night_wizard" title="nattsekvens">nattsekvens</button>
        <button class="btn ghost" id="reset_btn" title="nollställ omgång">nollställ</button>
        <span class="tag" id="gm_badge" style="display:none">GM MODE</span>
      </div>
    </div>
  </header>

  <main class="wrap grid two" id="app_root">
    <!-- ritual flow (vänster) -->
    <section class="card panel-spot">
      <h2>ritual flow</h2>
      <div class="divider"></div>

      <!-- phase + timer -->
      <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
        <section class="card">
          <h3>fas</h3>
          <div class="row" style="margin-top:6px">
            <button class="btn primary" id="btn_night">natt</button>
            <button class="btn" id="btn_day">dag</button>
          </div>
        </section>
        <section class="card">
          <h3>timer</h3>
          <div class="row" style="margin-top:6px">
            <button class="btn" id="timer_start">start</button>
            <button class="btn" id="timer_stop">stopp</button>
            <button class="btn" id="timer_reset">återställ</button>
          </div>
        </section>
      </div>

      <div class="divider"></div>

      <!-- current scene -->
      <section class="card scene-card fade-in">
        <h3><span class="moon"></span>scen <span id="scene_idx">1</span>: <span id="scene_title"></span></h3>
        <p id="scene_text" style="margin-top:6px"></p>
        <div class="row" style="margin-top:10px">
          <button class="btn good" id="scene_next"
            data-matomo-name="scene-next" data-matomo-event="click" data-matomo-category="scene" data-matomo-action="advance">nästa scen</button>
          <button class="btn warn" id="scene_repeat">repetera</button>
        </div>
      </section>

      <div class="divider"></div>

      <!-- voting -->
      <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
        <section class="card">
          <h3>röstning</h3>
          <div id="vote_tokens" class="tags" style="margin-top:6px"></div>
          <div class="row" style="margin-top:8px">
            <button class="btn primary" id="vote_add_from_players">lägg kandidat</button>
            <button class="btn warn" id="vote_clear">rensa</button>
            <button class="btn good" id="vote_result">visa resultat</button>
          </div>
        </section>
        <section class="card">
          <h3>anteckningar</h3>
          <textarea id="notes" rows="6" placeholder="misstankar, dödsordning, ledtrådar..."></textarea>
          <div class="row" style="margin-top:8px">
            <div class="grow" style="color:var(--muted)">autosparas lokalt</div>
            <button class="btn ghost" id="notes_clear">töm</button>
          </div>
        </section>
      </div>
    </section>

    <!-- gm arsenal (höger) -->
    <section class="card gm-ring" id="gm_panel" style="display:none">
      <h2>gm arsenal</h2>
      <div class="divider"></div>

      <section class="card">
        <h3>spelare</h3>
        <div class="list" id="players_list"></div>
        <div class="row" style="margin-top:8px">
          <input id="player_name" placeholder="ny spelare (namn)" />
          <button class="btn primary" id="player_add"
            data-matomo-name="player-add" data-matomo-event="click" data-matomo-category="players" data-matomo-action="add">lägg till</button>
        </div>
      </section>

      <section class="card">
        <h3>roller</h3>
        <div class="tags" id="roles_chips"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn good" id="assign_roles">dela ut roller</button>
          <button class="btn warn" id="clear_roles">rensa roller</button>
        </div>
      </section>

      <section class="card">
        <h3>scener</h3>
        <div class="list" id="scenes_list"></div>
        <div class="row" style="margin-top:8px">
          <input id="scene_custom" placeholder="snabb scen — rubrik :: text" />
          <button class="btn" id="scene_add_quick">lägg till</button>
        </div>
      </section>

      <section class="card">
        <h3>inställningar</h3>
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
          <div>
            <label class="muted">gm-pin</label>
            <input id="pin_input" value="1349"/>
          </div>
          <div>
            <label class="muted">återställ allt</label><br/>
            <button class="btn bad" id="hard_reset">rensa localStorage</button>
          </div>
        </div>
      </section>
    </section>
  </main>

  <!-- candidate picker -->
  <dialog id="candidate_modal">
    <h3>lägg kandidat</h3>
    <p class="muted" style="margin-bottom:8px">välj en levande spelare</p>
    <select id="candidate_select"></select>
    <div class="row" style="margin-top:10px; justify-content:flex-end">
      <button class="btn ghost" id="candidate_cancel">avbryt</button>
      <button class="btn primary" id="candidate_ok">lägg till</button>
    </div>
  </dialog>

  <!-- night stepper overlay -->
  <div id="overlay" aria-hidden="true">
    <div class="overlay-card">
      <h2>nattens ritual</h2>
      <div class="steps" id="steps_row"></div>
      <div class="card" id="step_body" style="margin-top:8px; min-height:88px"></div>
      <div class="row" style="margin-top:10px; justify-content:flex-end">
        <button class="btn ghost" id="overlay_close">stäng</button>
        <button class="btn primary" id="overlay_prev">tillbaka</button>
        <button class="btn good" id="overlay_next">nästa</button>
      </div>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

  <footer class="wrap" style="opacity:.7; font-size:12px; padding:16px">
    byggd för rummet — ingen backend. ändra story/roller i koden. tips: <span class="kbd">n</span> natt, <span class="kbd">d</span> dag, <span class="kbd">space</span> timer start/stopp.
  </footer>

  <script>
  /* ===================== data & state ===================== */
  const defaultData = {
    story:{
      title:"Skuggor över Vargtjärn",
      scenes:[
        { title:"ankomst", text:"Dimman ligger lågt över tjärnen. Ett avlägset yl bryter tystnaden." },
        { title:"värdshuset", text:"Anslagstavlan: flera försvinnanden. Lokala viskningar om en förbannelse." },
        { title:"spåren", text:"Klösmärken i skogsbrynet… och märken av bojor. Någon försöker hålla något inne." },
        { title:"gammelstugan", text:"En dagbok nämner måndatum och ett namn. Vad döljer byn?" },
        { title:"uppgörelsen", text:"Mörkret sänker sig. Sanningar dras upp till ytan vid tjärnens kant." }
      ]
    },
    roles:[
      { id:"varulv", name:"Varulv", team:"ulv", secret:"Du jagar om natten. Peka diskret på ett offer när GM ber." },
      { id:"sierska", name:"Sierska", team:"by", secret:"Varje natt kan du undersöka en spelare (ulv eller inte)." },
      { id:"jägare", name:"Jägare", team:"by", secret:"Om du dör får du ta med dig någon." },
      { id:"bybo",  name:"Bybo",  team:"by",  secret:"Ingen kraft. Din styrka är din röst." }
    ]
  };

  const state = {
    pin:"1349",
    phase:"natt",
    timer:0, timerHandle:null,
    sceneIndex:0,
    players:[], // {name, roleId?, alive:true}
    votes:{}, // name -> count
    notes:"",
    data: JSON.parse(localStorage.getItem("janpire_data") || JSON.stringify(defaultData))
  };

  /* ===================== helpers ===================== */
  const $ = s => document.querySelector(s);
  const el = (tag, attrs={}, children=[])=>{
    const n=document.createElement(tag);
    for(const [k,v] of Object.entries(attrs)){
      if(k==="class") n.className=v;
      else if(k==="text") n.textContent=v;
      else if(k.startsWith("on")) n.addEventListener(k.slice(2), v);
      else n.setAttribute(k,v);
    }
    children.forEach(c=>n.appendChild(typeof c==="string"?document.createTextNode(c):c));
    return n;
  };
  const save = ()=>{
    localStorage.setItem("janpire_state", JSON.stringify({
      phase:state.phase, timer:state.timer, sceneIndex:state.sceneIndex,
      players:state.players, votes:state.votes, notes:state.notes
    }));
    localStorage.setItem("janpire_data", JSON.stringify(state.data));
  };
  const load = ()=>{
    const raw=localStorage.getItem("janpire_state");
    if(!raw) return;
    try{ Object.assign(state, JSON.parse(raw)); }catch(e){ console.warn(e); }
  };
  const toast = (msg)=>{ const t=$("#toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",1600); };
  const fmt = n => String(n).padStart(2,"0");

  /* ===================== render ===================== */
  function renderAll(){
    $("#phase_tag").textContent = "fas: " + state.phase;
    $("#scene_tag").textContent = "scen: " + (state.sceneIndex+1);
    $("#scene_idx").textContent = (state.sceneIndex+1);
    const scene = state.data.story.scenes[state.sceneIndex] || {title:"—",text:"—"};
    $("#scene_title").textContent = scene.title;
    $("#scene_text").textContent = scene.text;

    // players
    const plist=$("#players_list"); plist.innerHTML="";
    state.players.forEach((p,i)=>{
      const role = state.data.roles.find(r=>r.id===p.roleId);
      const roleClass = role ? roleClassName(role) : "";
      const aliveClass = (p.alive===false) ? "dead" : "";
      const roleName = role ? role.name : "—";
      plist.appendChild(el("div",{class:"li "+aliveClass},[
        el("div",{class:"portrait"},[
          el("div",{class:"avatar"}),
          el("div",{},[
            el("div",{text:p.name}),
            el("div",{class:"muted", text:(p.alive===false?"ute":"levande")+" • "+roleName})
          ])
        ]),
        el("div",{},[
          el("span",{class:"rolechip "+roleClass, text:roleName}),
          el("button",{class:"btn", text:"hemligt", onclick:()=>revealSecret(p)}),
          el("button",{class:"btn warn", text:(p.alive===false?"markera levande":"markera ute"), onclick:()=>toggleAlive(i)}),
          el("button",{class:"btn ghost", text:"ta bort", onclick:()=>removePlayer(i)})
        ])
      ]));
    });

    // roles chips
    const rchips=$("#roles_chips"); rchips.innerHTML="";
    state.data.roles.forEach(r=>{
      const c = roleClassName(r);
      rchips.appendChild(el("span",{class:"tag rolechip "+c, title:r.secret, text:r.name}));
    });

    // scenes list
    const slist=$("#scenes_list"); slist.innerHTML="";
    state.data.story.scenes.forEach((s,idx)=>{
      slist.appendChild(
        el("div",{class:"li"},[
          el("div",{},[
            el("div",{text:`${idx+1}. ${s.title}`}),
            el("div",{class:"muted", text:s.text})
          ]),
          el("div",{},[
            el("button",{class:"btn", text:"gå hit", onclick:()=>{state.sceneIndex=idx; save(); renderAll();}})
          ])
        ])
      );
    });

    // votes
    renderVotes();
  }

  function renderVotes(){
    const box=$("#vote_tokens"); box.innerHTML="";
    const items = Object.entries(state.votes).sort((a,b)=>b[1]-a[1]);
    const max = items[0]?.[1] ?? 0;
    items.forEach(([name,count])=>{
      const top = count===max && count>0 ? "panel-spot" : "";
      const chip = el("span",{class:"tag "+top},[
        el("strong",{text:name}), document.createTextNode(" • "),
        el("span",{text:count})
      ]);
      const plus = el("button",{class:"btn", text:"+", onclick:()=>vote(name)});
      const minus = el("button",{class:"btn warn", text:"−", onclick:()=>unvote(name)});
      const rm = el("button",{class:"btn ghost", text:"x", onclick:()=>removeVote(name)});
      const wrap = el("div",{class:"row"},[chip, plus, minus, rm]);
      box.appendChild(wrap);
    });
  }

  function roleClassName(r){
    if(r.id==="varulv") return "r-ulv";
    if(r.id==="sierska") return "r-seer";
    if(r.id==="jägare") return "r-hunt";
    return "r-by";
  }

  function revealSecret(p){
    const role = state.data.roles.find(r=>r.id===p.roleId);
    const txt = role ? `roll: ${role.name}\nlag: ${role.team}\n\nhemligt:\n${role.secret}` : "ingen roll utdelad än.";
    alert(`${p.name}\n\n${txt}`);
  }

  /* ===================== actions ===================== */
  function addPlayer(){
    const name=$("#player_name").value.trim();
    if(!name) return;
    state.players.push({name, alive:true});
    $("#player_name").value="";
    save(); renderAll(); toast("spelare tillagd");
  }
  function removePlayer(i){ state.players.splice(i,1); save(); renderAll(); }
  function toggleAlive(i){ state.players[i].alive = (state.players[i].alive===false); save(); renderAll(); }

  function assignRoles(){
    if(state.players.length===0) return toast("lägg till spelare först");
    // minst 1 ulv, 1 sierska, 1 jägare, resten bybor (skalar ulvar ~1/5)
    const pool=[];
    const wolves = Math.max(1, Math.floor(state.players.length/5));
    for(let i=0;i<wolves;i++) pool.push("varulv");
    pool.push("sierska"); pool.push("jägare");
    while(pool.length<state.players.length) pool.push("bybo");
    shuffle(pool);
    state.players = state.players.map((p,i)=>({...p, roleId: pool[i]}));
    save(); renderAll(); toast("roller utdelade");
  }
  function clearRoles(){ state.players = state.players.map(p=>({...p, roleId:undefined})); save(); renderAll(); }

  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

  function setPhase(p){
    state.phase = p;
    $("#btn_night").classList.toggle("primary", p==="natt");
    $("#btn_day").classList.toggle("primary", p==="dag");
    save(); renderAll();
  }

  // timer
  function tick(){
    state.timer++;
    const m=Math.floor(state.timer/60), s=state.timer%60;
    $("#timer_tag").textContent = `timer: ${fmt(m)}:${fmt(s)}`;
  }
  function timerStart(){ if(state.timerHandle) return; state.timerHandle=setInterval(tick,1000); }
  function timerStop(){ clearInterval(state.timerHandle); state.timerHandle=null; }
  function timerReset(){ state.timer=0; $("#timer_tag").textContent="timer: 00:00"; }

  // scenes
  function nextScene(){ state.sceneIndex = Math.min(state.sceneIndex+1, state.data.story.scenes.length-1); save(); renderAll(); }
  function repeatScene(){ renderAll(); toast("scen repeterad"); }
  function addCustomScene(){
    const raw=$("#scene_custom").value.trim();
    if(!raw) return;
    const [title, ...rest]=raw.split("::");
    const text=rest.join("::").trim()||"—";
    state.data.story.scenes.push({title:title.trim(), text});
    $("#scene_custom").value=""; save(); renderAll();
  }

  // votes
  function vote(name){ state.votes[name]=(state.votes[name]||0)+1; save(); renderVotes(); bounceTag(name); }
  function unvote(name){
    if(!state.votes[name]) return;
    state.votes[name]=Math.max(0,state.votes[name]-1);
    if(state.votes[name]===0) delete state.votes[name];
    save(); renderVotes();
  }
  function removeVote(name){ delete state.votes[name]; save(); renderVotes(); }
  function clearVotes(){ state.votes={}; save(); renderVotes(); toast("röster rensade"); }
  function showVoteResult(){
    const entries=Object.entries(state.votes); if(entries.length===0) return toast("inga röster än");
    const sorted=entries.sort((a,b)=>b[1]-a[1]);
    const topScore=sorted[0][1];
    const winners=sorted.filter(([,c])=>c===topScore).map(([n])=>n);
    alert(`flest röster: ${winners.join(", ")} (${topScore})`);
  }
  function bounceTag(name){
    // simple visual: re-render already happens; no-op placeholder for CSS anim hooks if needed
  }

  // gm toggle
  let gmOpen=false;
  function toggleGM(){
    if(gmOpen){ gmOpen=false; $("#gm_panel").style.display="none"; $("#gm_badge").style.display="none"; return; }
    const pin = prompt("ange gm-pin");
    if(pin===state.pin){ gmOpen=true; $("#gm_panel").style.display="block"; $("#gm_badge").style.display="inline-flex"; }
    else toast("fel pin");
  }

  // storage reset
  function hardReset(){
    if(confirm("rensa allt och börja om?")){
      localStorage.removeItem("janpire_state");
      localStorage.removeItem("janpire_data");
      location.reload();
    }
  }

  /* ===================== dialogs / overlay ===================== */
  const candidateModal = $("#candidate_modal");
  function openCandidatePicker(){
    const sel=$("#candidate_select"); sel.innerHTML="";
    const live=state.players.filter(p=>p.alive!==false);
    if(live.length===0){ toast("inga levande spelare"); return; }
    live.forEach(p=>sel.appendChild(el("option",{value:p.name, text:p.name})));
    candidateModal.showModal();
  }
  $("#candidate_cancel").addEventListener("click", ()=>candidateModal.close());
  $("#candidate_ok").addEventListener("click", ()=>{
    const name=$("#candidate_select").value;
    if(name){ state.votes[name]=(state.votes[name]||0); save(); renderVotes(); }
    candidateModal.close();
  });

  // night wizard
  const steps = [
    { id:"all_blind",  title:"alla blundar",    body:"Alla blundar. Tystnad faller över byn." },
    { id:"wolves",     title:"varulvarna vaknar", body:"Varulvarna öppnar ögonen och pekar ut ett offer. Bekräfta när du sett." },
    { id:"seer",       title:"sierskan vaknar", body:"Sierskan pekar på en spelare. Viskande: ‘ulv’ eller ‘inte ulv’." },
    { id:"others",     title:"andra effekter",  body:"Andra roller (om du lagt till dem) aktiveras. Annars hoppa vidare." },
    { id:"dawn",       title:"gryning",         body:"Morgonen gryr. Avslöja nattens konsekvenser (offret), men inte gärningsman." }
  ];
  let stepIdx=0;
  function openWizard(){
    stepIdx=0; renderWizard(); $("#overlay").classList.add("show"); $("#overlay").setAttribute("aria-hidden","false");
  }
  function closeWizard(){ $("#overlay").classList.remove("show"); $("#overlay").setAttribute("aria-hidden","true"); }
  function renderWizard(){
    const row=$("#steps_row"); row.innerHTML="";
    steps.forEach((s,i)=> row.appendChild(el("span",{class:"step "+(i===stepIdx?"active":""), text:`${i+1}. ${s.title.toUpperCase()}`})));
    const s=steps[stepIdx];
    $("#step_body").innerHTML = `<p>${s.body}</p>`;
    $("#overlay_prev").disabled = (stepIdx===0);
    $("#overlay_next").textContent = stepIdx===steps.length-1 ? "avsluta" : "nästa";
  }

  /* ===================== wire up ===================== */
  function bind(){
    // phase + timer
    $("#btn_night").addEventListener("click", ()=>setPhase("natt"));
    $("#btn_day").addEventListener("click", ()=>setPhase("dag"));
    $("#timer_start").addEventListener("click", timerStart);
    $("#timer_stop").addEventListener("click", timerStop);
    $("#timer_reset").addEventListener("click", timerReset);

    // scene
    $("#scene_next").addEventListener("click", nextScene);
    $("#scene_repeat").addEventListener("click", repeatScene);

    // votes
    $("#vote_add_from_players").addEventListener("click", openCandidatePicker);
    $("#vote_clear").addEventListener("click", clearVotes);
    $("#vote_result").addEventListener("click", showVoteResult);

    // notes
    $("#notes").addEventListener("input", e=>{ state.notes=e.target.value; save(); });
    $("#notes_clear").addEventListener("click", ()=>{ $("#notes").value=""; state.notes=""; save(); });

    // gm
    $("#gm_toggle").addEventListener("click", toggleGM);
    $("#pin_input").addEventListener("change", e=>{ state.pin=e.target.value.trim(); toast("pin uppdaterad"); });
    $("#hard_reset").addEventListener("click", hardReset);
    $("#reset_btn").addEventListener("click", ()=>{ if(confirm("nollställ spel (behåller story/roller)?")){ localStorage.removeItem("janpire_state"); location.reload(); } });

    // players & roles
    $("#player_add").addEventListener("click", addPlayer);
    $("#assign_roles").addEventListener("click", assignRoles);
    $("#clear_roles").addEventListener("click", clearRoles);

    // scenes
    $("#scene_add_quick").addEventListener("click", addCustomScene);

    // overlay
    $("#night_wizard").addEventListener("click", openWizard);
    $("#overlay_close").addEventListener("click", closeWizard);
    $("#overlay_prev").addEventListener("click", ()=>{ if(stepIdx>0){ stepIdx--; renderWizard(); }});
    $("#overlay_next").addEventListener("click", ()=>{
      if(stepIdx<steps.length-1){ stepIdx++; renderWizard(); }
      else { closeWizard(); setPhase("dag"); }
    });

    // keyboard
    document.addEventListener("keydown",(e)=>{
      if(e.key==="n") setPhase("natt");
      if(e.key==="d") setPhase("dag");
      if(e.key===" "){ e.preventDefault(); state.timerHandle?timerStop():timerStart(); }
    });
  }

  /* ===================== boot ===================== */
  load();
  if(state.sceneIndex>=state.data.story.scenes.length) state.sceneIndex=0;
  renderAll(); bind();

  // expose for debug
  window.__janpire={state, save, renderAll};

  // (valfritt) matomo init kan placeras här om du använder det.
  // var _paq = window._paq = window._paq || [];
  // _paq.push(['trackPageView']); _paq.push(['enableLinkTracking']);
  // (function(){ var u="https://your-matomo.example/"; _paq.push(['setTrackerUrl', u+'matomo.php']); _paq.push(['setSiteId', '1']);
  // var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0]; g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s); })();
  </script>
</body>
</html>