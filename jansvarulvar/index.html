<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JANPIRE — den förbannade tjärnen</title>
<meta name="theme-color" content="#0b0d10" />
<style>
  :root{
    --bg:#0b0d10; --bg2:#0f141b; --panel:#10141b; --ink:#0e141d;
    --text:#e8ecff; --sub:#cfd6ff; --muted:#8d97aa;
    --accent:#6cc0ff; --border:#1b2332;
    --good:#58e1a3; --warn:#f7b955; --bad:#ff6b6b;
    --r:12px; --soft:0 10px 30px rgba(0,0,0,.4);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;color:var(--text);
    background:radial-gradient(1200px 700px at 20% -10%,#111725 0%,#0b0d10 60%) fixed;
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;
    letter-spacing:.2px;
  }
  h1,h2,h3{margin:0 0 8px}
  h1{font:700 22px/1.2 Georgia,serif;letter-spacing:.06em;text-transform:uppercase}
  h2{font:700 16px/1.2 Georgia,serif;letter-spacing:.06em;text-transform:uppercase;color:var(--sub)}
  h3{font:600 14px/1.2 Georgia,serif;letter-spacing:.05em;text-transform:uppercase;color:#b8c2ff}
  p{margin:0 0 10px;color:#c7cee0}

  header{position:sticky;top:0;z-index:5;backdrop-filter:saturate(115%) blur(6px);
    background:linear-gradient(180deg,rgba(10,14,19,.92),rgba(10,14,19,.65) 80%,transparent);
    border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .grow{flex:1 1 auto}
  main{padding:14px 16px}
  .grid{display:grid;gap:14px}
  .two{grid-template-columns:1.1fr .9fr}
  @media (max-width:980px){.two{grid-template-columns:1fr}}

  .card{background:linear-gradient(180deg,var(--panel),var(--bg2));border:1px solid var(--border);border-radius:12px;box-shadow:var(--soft);padding:14px}
  .spot{box-shadow:0 0 0 1px rgba(108,192,255,.18), 0 12px 38px rgba(12,30,55,.55);border-color:#28354c}
  .divider{height:1px;background:var(--border);margin:10px 0}
  .tags{display:flex;gap:8px;flex-wrap:wrap}
  .tag{display:inline-flex;gap:8px;align-items:center;padding:5px 10px;border:1px solid var(--border);border-radius:999px;background:#0f1723;color:var(--muted);font-size:12px}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;padding:2px 6px;border-radius:6px;border:1px solid var(--border);background:#0e141d;color:#cfd8ff}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--ink);color:var(--text);outline:none}
  input:focus,select:focus,textarea:focus{box-shadow:0 0 0 3px rgba(108,192,255,.25)}
  textarea{min-height:110px;resize:vertical}
  .btn{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg,#1a2534,#111924);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;transition:.15s transform,.2s filter,.2s border-color;box-shadow:var(--soft)}
  .btn:active{transform:translateY(1px)} .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn.primary{border-color:#2a3242;background:linear-gradient(180deg,#1d2532,#141a24)}
  .btn.good{border-color:#244238;background:linear-gradient(180deg,#123327,#0c241c)}
  .btn.warn{border-color:#403424;background:linear-gradient(180deg,#2f2915,#201c10)}
  .btn.bad{border-color:#402427;background:linear-gradient(180deg,#2f1518,#201014)}
  .btn.ghost{background:transparent}

  /* scenlista */
  .li{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px;border:1px dashed var(--border);border-radius:10px;background:#0f151d}
  .li.dragging{opacity:.5}
  .handle{cursor:grab;border:1px solid var(--border);border-radius:6px;background:#0e141d;padding:6px 8px;font:600 12px/1 ui-monospace,Menlo}
  .ghost-marker{height:40px;border:1px dashed #2a3c57;border-radius:10px;margin:6px 0}

  /* dialog + fallback */
  dialog{border:1px solid var(--border);border-radius:12px;padding:14px;background:#0e141d;color:#fff;box-shadow:var(--soft);max-width:520px}
  dialog::backdrop{background:rgba(2,6,12,.7)}
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,12,.7);display:none;align-items:center;justify-content:center;z-index:60}
  .modal-backdrop.show{display:flex}
  .hint{color:var(--muted);font-size:13px}

  /* overlay (nattguide) */
  #overlay{position:fixed;inset:0;background:rgba(4,7,12,.85);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:50}
  #overlay.show{display:flex}
  .overlay-card{width:min(720px,92vw);background:linear-gradient(180deg,#0f1520,#0a0f16);border:1px solid #28354c;border-radius:14px;padding:16px;box-shadow:0 0 0 1px rgba(108,192,255,.18), 0 12px 38px rgba(12,30,55,.55)}
  .steps{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .step{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0e1722;color:var(--muted);font-size:12px}
  .step.active{color:#d7e6ff;border-color:#2a3c57;box-shadow:0 0 0 2px rgba(108,192,255,.15) inset}

  #toast{position:fixed;bottom:16px;right:16px;display:none;background:#0f1723;border:1px solid var(--border);border-radius:10px;padding:10px 12px;box-shadow:var(--soft)}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div class="grow">
      <h1>JANPIRE — DEN FÖRBANNADE TJÄRNEN</h1>
      <div class="tags" style="margin-top:6px">
        <span class="tag" id="phase_tag">fas: natt</span>
        <span class="tag" id="scene_tag">scen: 1</span>
        <span class="tag" id="timer_tag">timer: 00:00</span>
        <span class="tag" id="gm_badge" style="display:none">GM MODE</span>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="gm_toggle">gm-läge</button>
      <button class="btn" id="night_wizard">nattsekvens</button>
      <button class="btn ghost" id="reset_btn">nollställ</button>
    </div>
  </div>
</header>

<main class="wrap grid two" id="app_root">
  <section class="card spot">
    <h2>ritual flow</h2>
    <p class="hint">börja i gm-panelen: lägg spelare och dela ut roller.</p>
    <div class="divider"></div>

    <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
      <section class="card">
        <h3>fas</h3>
        <div class="row" style="margin-top:6px">
          <button class="btn primary" id="btn_night">natt</button>
          <button class="btn" id="btn_day">dag</button>
        </div>
      </section>
      <section class="card">
        <h3>timer</h3>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="timer_start">start</button>
          <button class="btn" id="timer_stop">stopp</button>
          <button class="btn" id="timer_reset">återställ</button>
        </div>
      </section>
    </div>

    <div class="divider"></div>

    <section class="card scene-card">
      <h3>scen <span id="scene_idx">1</span>: <span id="scene_title"></span></h3>
      <p id="scene_text" style="margin-top:6px"></p>
      <div class="row" style="margin-top:10px">
        <button class="btn good" id="scene_next">nästa scen</button>
        <button class="btn warn" id="scene_repeat">repetera</button>
        <button class="btn" id="scene_edit_current">editera</button>
      </div>
    </section>

    <div class="divider"></div>

    <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
      <section class="card">
        <h3>röstning</h3>
        <div id="vote_tokens" class="tags" style="margin-top:6px"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" id="vote_add_from_players">lägg kandidat</button>
          <button class="btn warn" id="vote_clear">rensa</button>
          <button class="btn good" id="vote_result">visa resultat</button>
        </div>
      </section>
      <section class="card">
        <h3>anteckningar</h3>
        <textarea id="notes" rows="6" placeholder="misstankar, dödsordning, ledtrådar..."></textarea>
        <div class="row" style="margin-top:8px">
          <div class="grow hint">autosparas lokalt</div>
          <button class="btn ghost" id="notes_clear">töm</button>
        </div>
      </section>
    </div>
  </section>

  <section class="card" id="gm_panel">
    <h2>gm arsenal</h2>
    <div class="divider"></div>

    <section class="card">
      <h3>snabbstart</h3>
      <div class="row">
        <button class="btn good" id="seed_demo">ladda demo</button>
        <button class="btn" id="export_btn">export json</button>
        <label class="btn ghost" for="import_file" style="cursor:pointer">import json</label>
        <input id="import_file" type="file" accept="application/json" style="display:none" />
      </div>
      <p class="hint" style="margin-top:6px">demo: 8 spelare, balanserade roller, scen 1.</p>
    </section>

    <section class="card">
      <h3>spelare</h3>
      <div class="list" id="players_list"></div>
      <div class="row" style="margin-top:8px">
        <input id="player_name" placeholder="ny spelare (namn)" />
        <button class="btn primary" id="player_add">lägg till</button>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="player_bulk" placeholder="snabbadd: alva, johan, my" />
        <button class="btn" id="player_bulk_add">lägg flera</button>
      </div>
    </section>

    <section class="card">
      <h3>roller</h3>
      <div class="tags" id="roles_chips"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn good" id="assign_roles">dela ut roller</button>
        <button class="btn warn" id="clear_roles">rensa roller</button>
      </div>
    </section>

    <section class="card">
      <h3>scener</h3>
      <div class="row" style="margin-bottom:8px;justify-content:space-between">
        <div class="hint">klicka för att editera, dra handtaget för att flytta</div>
        <button class="btn primary" id="scene_new">ny scen</button>
      </div>
      <div class="list" id="scenes_list" aria-live="polite"></div>
    </section>

    <section class="card">
      <h3>inställningar</h3>
      <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label class="hint">gm-pin</label>
          <input id="pin_input" value="1349"/>
        </div>
        <div>
          <label class="hint">återställ allt</label><br/>
          <button class="btn bad" id="hard_reset">rensa localStorage</button>
        </div>
      </div>
    </section>
  </section>
</main>

<!-- kandidatväljare -->
<dialog id="candidate_modal">
  <h3>lägg kandidat</h3>
  <p class="hint" style="margin-bottom:8px">välj en levande spelare</p>
  <select id="candidate_select"></select>
  <div class="row" style="margin-top:10px;justify-content:flex-end">
    <button class="btn ghost" id="candidate_cancel" type="button">avbryt</button>
    <button class="btn primary" id="candidate_ok" type="button">lägg till</button>
  </div>
</dialog>

<!-- scen-editor (dialog + fallback wrapper) -->
<div id="scene_backdrop" class="modal-backdrop">
  <div class="card" style="width:min(680px,94vw)">
    <h3 id="scene_modal_title">ny scen</h3>
    <label class="hint">titel</label>
    <input id="scene_form_title" placeholder="titel" />
    <label class="hint" style="margin-top:8px;display:block">text</label>
    <textarea id="scene_form_text" placeholder="scenens text"></textarea>
    <div class="row" style="margin-top:10px;justify-content:space-between">
      <div class="row">
        <button class="btn" id="scene_up" type="button" title="flytta upp">upp</button>
        <button class="btn" id="scene_down" type="button" title="flytta ner">ner</button>
        <button class="btn" id="scene_duplicate" type="button" title="duplicera">duplicera</button>
        <button class="btn bad" id="scene_delete" type="button" title="ta bort">ta bort</button>
      </div>
      <div class="row">
        <button class="btn ghost" id="scene_cancel" type="button">avbryt</button>
        <button class="btn good" id="scene_save" type="button">spara</button>
      </div>
    </div>
  </div>
</div>

<!-- nattsekvens -->
<div id="overlay" aria-hidden="true">
  <div class="overlay-card">
    <h2>nattens ritual</h2>
    <div class="steps" id="steps_row"></div>
    <div class="card" id="step_body" style="margin-top:8px;min-height:88px"></div>
    <div class="row" style="margin-top:10px;justify-content:flex-end">
      <button class="btn ghost" id="overlay_close" type="button">stäng</button>
      <button class="btn" id="overlay_prev" type="button">tillbaka</button>
      <button class="btn good" id="overlay_next" type="button">nästa</button>
    </div>
  </div>
</div>

<div id="toast" role="status" aria-live="polite"></div>

<footer class="wrap" style="opacity:.7;font-size:12px;padding:16px">
  tips: <span class="kbd">n</span> natt, <span class="kbd">d</span> dag, <span class="kbd">space</span> start/stopp timer.
</footer>

<script>
/* ===== core data ===== */
const coreRoles = [
  { id:"varulv", name:"Varulv", team:"ulv", secret:"Du jagar om natten. Peka diskret på ett offer när GM ber." },
  { id:"sierska", name:"Sierska", team:"by", secret:"Varje natt kan du undersöka en spelare (ulv eller inte)." },
  { id:"jägare", name:"Jägare", team:"by", secret:"Om du dör får du ta med dig någon." },
  { id:"bybo",  name:"Bybo",  team:"by",  secret:"Ingen kraft. Din styrka är din röst." }
];
const defaultData = {
  story:{
    title:"Skuggor över Vargtjärn",
    scenes:[
      { title:"ankomst", text:"Dimman ligger lågt över tjärnen. Ett avlägset yl bryter tystnaden." },
      { title:"värdshuset", text:"Anslagstavlan: försvinnanden. Viskningar om en förbannelse." },
      { title:"spåren", text:"Klösmärken i skogsbrynet… och märken av bojor." },
      { title:"gammelstugan", text:"Dagboken nämner måndatum och ett namn. Någon döljer sanningen." },
      { title:"uppgörelsen", text:"Mörkret sänker sig. Byn samlas vid tjärnen för sanningen." }
    ]
  },
  roles:[...coreRoles]
};

/* ===== state ===== */
const state = {
  pin:"1349",
  phase:"natt",
  timer:0, timerHandle:null,
  sceneIndex:0,
  players:[], votes:{}, notes:"",
  data: JSON.parse(localStorage.getItem("janpire_data") || JSON.stringify(defaultData))
};

/* ===== dom ===== */
const $=s=>document.querySelector(s);
const el=(t,a={},c=[])=>{const n=document.createElement(t);for(const[k,v]of Object.entries(a)){if(k==="class")n.className=v;else if(k==="text")n.textContent=v;else if(k.startsWith("on"))n.addEventListener(k.slice(2),v);else n.setAttribute(k,v)}c.forEach(x=>n.appendChild(typeof x==="string"?document.createTextNode(x):x));return n};
const toast=msg=>{const t=$("#toast");t.textContent=msg;t.style.display="block";setTimeout(()=>t.style.display="none",1700)};
const save=()=>{localStorage.setItem("janpire_state",JSON.stringify({phase:state.phase,timer:state.timer,sceneIndex:state.sceneIndex,players:state.players,votes:state.votes,notes:state.notes}));localStorage.setItem("janpire_data",JSON.stringify(state.data))};
const load=()=>{const raw=localStorage.getItem("janpire_state");if(!raw)return;try{Object.assign(state,JSON.parse(raw))}catch(e){console.warn(e)}};
const fmt=n=>String(n).padStart(2,"0");

/* ===== render ===== */
function renderAll(){
  $("#phase_tag").textContent="fas: "+state.phase;
  $("#scene_tag").textContent="scen: "+(state.sceneIndex+1);
  $("#scene_idx").textContent=(state.sceneIndex+1);
  const sc=state.data.story.scenes[state.sceneIndex]||{title:"—",text:"—"};
  $("#scene_title").textContent=sc.title; $("#scene_text").textContent=sc.text;

  // players
  const plist=$("#players_list"); plist.innerHTML="";
  state.players.forEach((p,i)=>{
    const role=state.data.roles.find(r=>r.id===p.roleId); const rn=role?role.name:"—"; const dead=(p.alive===false)?"dead":"";
    plist.appendChild(el("div",{class:"li "+dead},[
      el("div",{class:"row"},[
        el("div",{class:"handle",title:"drag"},["::"]),
        el("div",{},[el("div",{text:p.name}), el("div",{class:"hint",text:(p.alive===false?"ute":"levande")+" • "+rn})])
      ]),
      el("div",{},[
        el("button",{class:"btn",text:"hemligt",onclick:()=>revealSecret(p)}),
        el("button",{class:"btn warn",text:(p.alive===false?"markera levande":"markera ute"),onclick:()=>toggleAlive(i)}),
        el("button",{class:"btn ghost",text:"ta bort",onclick:()=>removePlayer(i)})
      ])
    ]));
  });

  // roles chips
  const rchips=$("#roles_chips"); rchips.innerHTML="";
  state.data.roles.forEach(r=>rchips.appendChild(el("span",{class:"tag",title:r.secret,text:r.name})));

  // scenes
  renderScenesList();

  // votes
  renderVotes();

  $("#assign_roles").disabled = state.players.length===0;
}

function renderVotes(){
  const box=$("#vote_tokens"); box.innerHTML="";
  const items=Object.entries(state.votes).sort((a,b)=>b[1]-a[1]); const max=items[0]?.[1]??0;
  items.forEach(([name,count])=>{
    const top=count===max && count>0 ? "spot" : "";
    const chip=el("span",{class:"tag "+top},[el("strong",{text:name}),document.createTextNode(" • "),el("span",{text:count})]);
    const plus=el("button",{class:"btn",text:"+",onclick:()=>vote(name)});
    const minus=el("button",{class:"btn warn",text:"−",onclick:()=>unvote(name)});
    const rm=el("button",{class:"btn ghost",text:"x",onclick:()=>removeVote(name)});
    box.appendChild(el("div",{class:"row"},[chip,plus,minus,rm]));
  });
}

/* ===== players ===== */
function addPlayer(){ const name=$("#player_name").value.trim(); if(!name){toast("ange namn"); return;}
  if(state.players.some(p=>p.name.toLowerCase()===name.toLowerCase())){toast("namn redan tillagt"); return;}
  state.players.push({name,alive:true}); $("#player_name").value=""; save(); renderAll(); toast("spelare tillagd");
}
function addPlayersBulk(){
  const raw=$("#player_bulk").value.trim(); if(!raw){toast("inga namn"); return;}
  const names=[...new Set(raw.split(",").map(s=>s.trim()).filter(Boolean))];
  let added=0; names.forEach(n=>{ if(!state.players.some(p=>p.name.toLowerCase()===n.toLowerCase())){ state.players.push({name:n,alive:true}); added++; }});
  $("#player_bulk").value=""; save(); renderAll(); toast(`tillagda: ${added}`);
}
function removePlayer(i){ state.players.splice(i,1); save(); renderAll(); }
function toggleAlive(i){ state.players[i].alive = !(state.players[i].alive===false); save(); renderAll(); }

/* ===== roles ===== */
function assignRoles(){
  if(state.players.length===0){ toast("lägg spelare först"); return; }
  const pool=[]; const wolves=Math.max(1,Math.floor(state.players.length/5));
  for(let i=0;i<wolves;i++) pool.push("varulv"); if(state.data.roles.some(r=>r.id==="sierska")) pool.push("sierska");
  if(state.data.roles.some(r=>r.id==="jägare")) pool.push("jägare"); while(pool.length<state.players.length) pool.push("bybo");
  shuffle(pool); state.players = state.players.map((p,i)=>({...p,roleId: pool[i]}));
  save(); renderAll(); toast("roller utdelade");
}
function clearRoles(){ state.players = state.players.map(p=>({...p,roleId:undefined})); save(); renderAll(); toast("roller rensade"); }

/* ===== scenes: list + dnd + editor ===== */
function renderScenesList(){
  const sl=$("#scenes_list"); sl.innerHTML="";
  state.data.story.scenes.forEach((s,idx)=>{
    const row = el("div",{class:"li", "data-idx":String(idx)},[
      el("div",{class:"row"},[
        el("div",{class:"handle",title:"dra för att flytta"},["::"]),
        el("div",{onclick:()=>openSceneEditor(idx), style:"cursor:pointer"},[
          el("div",{text:`${idx+1}. ${s.title}`}),
          el("div",{class:"hint", text:s.text})
        ])
      ]),
      el("div",{},[
        el("button",{class:"btn", text:"gå hit", onclick:()=>{state.sceneIndex=idx; save(); renderAll();}}),
        el("button",{class:"btn", text:"upp", onclick:()=>moveScene(idx, -1)}),
        el("button",{class:"btn", text:"ner", onclick:()=>moveScene(idx, 1)})
      ])
    ]);
    sl.appendChild(row);
  });
  enableSceneDnd(sl);
}

function moveScene(from, delta){
  const to = from + delta;
  const arr = state.data.story.scenes;
  if(to<0 || to>=arr.length) return;
  const [m] = arr.splice(from,1);
  arr.splice(to,0,m);
  if(state.sceneIndex===from) state.sceneIndex=to;
  save(); renderScenesList(); renderHeaderScene();
}

function renderHeaderScene(){
  $("#scene_tag").textContent="scen: "+(state.sceneIndex+1);
  $("#scene_idx").textContent=(state.sceneIndex+1);
  const sc=state.data.story.scenes[state.sceneIndex]||{title:"—",text:"—"};
  $("#scene_title").textContent=sc.title; $("#scene_text").textContent=sc.text;
}

/* desktop drag-and-drop */
function enableSceneDnd(container){
  const rows = [...container.children];
  let dragEl=null, dragIdx=null, ghost=null;

  rows.forEach(row=>{
    const handle = row.querySelector(".handle");
    handle.setAttribute("draggable","true");
    handle.addEventListener("dragstart",(e)=>{
      dragEl = row;
      dragIdx = Number(row.getAttribute("data-idx"));
      e.dataTransfer.effectAllowed="move";
      e.dataTransfer.setData("text/plain", String(dragIdx)); // behövs för vissa browsers
      setTimeout(()=>row.classList.add("dragging"),0);
      // ghost marker
      ghost = document.createElement("div"); ghost.className="ghost-marker";
      container.insertBefore(ghost, row.nextSibling);
    });
    handle.addEventListener("dragend",()=>{
      if(dragEl) dragEl.classList.remove("dragging");
      if(ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);
      dragEl=null; ghost=null; dragIdx=null;
      // reindex och rendera om för säkerhets skull
      renderScenesList(); save();
    });
  });

  container.addEventListener("dragover",(e)=>{
    e.preventDefault();
    if(!ghost) return;
    const after = getDragAfterElement(container, e.clientY);
    if(after == null) container.appendChild(ghost);
    else container.insertBefore(ghost, after);
  });

  container.addEventListener("drop",(e)=>{
    e.preventDefault();
    if(!ghost) return;
    const newPos = [...container.children].indexOf(ghost);
    // ghost index motsvarar nya platsen
    const arr = state.data.story.scenes;
    const [moved] = arr.splice(dragIdx,1);
    const insertAt = Math.min(newPos, arr.length);
    arr.splice(insertAt,0,moved);
    if(state.sceneIndex===dragIdx) state.sceneIndex=insertAt;
    save();
  });

  function getDragAfterElement(container, y){
    const els = [...container.querySelectorAll(".li:not(.dragging)")];
    return els.reduce((closest, child)=>{
      const box = child.getBoundingClientRect();
      const offset = y - (box.top + box.height/2);
      if(offset < 0 && offset > closest.offset) return { offset, element: child };
      else return closest;
    }, {offset: Number.NEGATIVE_INFINITY}).element;
  }
}

/* editor modal (works on iOS via fallback) */
let sceneEditingIndex = null;
function openSceneEditor(idx=null){
  sceneEditingIndex = (idx==null? null : Number(idx));
  $("#scene_modal_title").textContent = (sceneEditingIndex==null) ? "ny scen" : `editera scen ${sceneEditingIndex+1}`;
  if(sceneEditingIndex==null){
    $("#scene_form_title").value = "";
    $("#scene_form_text").value  = "";
  }else{
    const s = state.data.story.scenes[sceneEditingIndex];
    $("#scene_form_title").value = s.title;
    $("#scene_form_text").value  = s.text;
  }
  showBackdrop(true);
}
function saveSceneFromModal(){
  const title=$("#scene_form_title").value.trim();
  const text =$("#scene_form_text").value.trim();
  if(!title){ toast("titel saknas"); return; }
  if(sceneEditingIndex==null){
    state.data.story.scenes.push({title,text});
    state.sceneIndex = state.data.story.scenes.length-1;
    toast("scen skapad");
  }else{
    state.data.story.scenes[sceneEditingIndex]={title,text};
    toast("scen sparad");
  }
  save(); renderScenesList(); renderHeaderScene(); showBackdrop(false);
}
function deleteSceneFromModal(){
  if(sceneEditingIndex==null) return;
  if(!confirm("ta bort denna scen?")) return;
  state.data.story.scenes.splice(sceneEditingIndex,1);
  if(state.sceneIndex>=state.data.story.scenes.length) state.sceneIndex = Math.max(0, state.data.story.scenes.length-1);
  save(); renderScenesList(); renderHeaderScene(); showBackdrop(false); toast("scen borttagen");
}
function duplicateSceneFromModal(){
  if(sceneEditingIndex==null) return;
  const s = state.data.story.scenes[sceneEditingIndex];
  state.data.story.scenes.splice(sceneEditingIndex+1,0,{title:s.title+" (kopia)",text:s.text});
  state.sceneIndex = sceneEditingIndex+1;
  save(); renderScenesList(); renderHeaderScene(); showBackdrop(false); toast("scen duplicerad");
}
function moveSceneInModal(delta){
  if(sceneEditingIndex==null) return;
  const from=sceneEditingIndex, to=from+delta;
  const arr=state.data.story.scenes;
  if(to<0 || to>=arr.length) return;
  const [m]=arr.splice(from,1); arr.splice(to,0,m);
  sceneEditingIndex=to; state.sceneIndex=to;
  save(); renderScenesList(); renderHeaderScene();
}

/* modal fallback helpers */
function showBackdrop(open){
  const bd = $("#scene_backdrop");
  bd.classList.toggle("show", !!open);
}

/* votes */
function vote(name){ state.votes[name]=(state.votes[name]||0)+1; save(); renderVotes(); }
function unvote(name){ if(!state.votes[name])return; state.votes[name]=Math.max(0,state.votes[name]-1); if(state.votes[name]===0) delete state.votes[name]; save(); renderVotes(); }
function removeVote(name){ delete state.votes[name]; save(); renderVotes(); }
function clearVotes(){ state.votes={}; save(); renderVotes(); toast("röster rensade"); }
function openCandidatePicker(){
  const sel=$("#candidate_select"); sel.innerHTML="";
  const live=state.players.filter(p=>p.alive!==false);
  if(live.length===0){ toast("inga levande spelare"); return; }
  live.forEach(p=>sel.appendChild(el("option",{value:p.name,text:p.name})));
  // Safari-fallback: använd <dialog> om stöds, annars alert-variant
  if(typeof HTMLDialogElement !== "undefined" && typeof $("#candidate_modal").showModal === "function"){
    $("#candidate_modal").showModal();
  }else{
    const name = prompt("välj kandidat:\n"+live.map(p=>p.name).join(", "));
    if(name){ state.votes[name]=(state.votes[name]||0); save(); renderVotes(); }
  }
}

/* phase & timer */
function setPhase(p){ state.phase=p; $("#btn_night").classList.toggle("primary",p==="natt"); $("#btn_day").classList.toggle("primary",p==="dag"); save(); renderAll(); }
function tick(){ state.timer++; const m=Math.floor(state.timer/60),s=state.timer%60; $("#timer_tag").textContent=`timer: ${fmt(m)}:${fmt(s)}` }
function timerStart(){ if(state.timerHandle) return; state.timerHandle=setInterval(tick,1000) }
function timerStop(){ clearInterval(state.timerHandle); state.timerHandle=null }
function timerReset(){ state.timer=0; $("#timer_tag").textContent="timer: 00:00" }

/* gm toggle */
let gmOpen=false;
function openGM(){ gmOpen=true; $("#gm_panel").style.display="block"; $("#gm_badge").style.display="inline-flex" }
function closeGM(){ gmOpen=false; $("#gm_panel").style.display="none"; $("#gm_badge").style.display="none" }
function toggleGM(){ if(gmOpen){ closeGM(); return; } const pin=prompt("ange gm-pin"); if(pin===state.pin){ openGM(); } else { toast("fel pin") } }

/* seed / import / export */
function seedDemo(){
  state.players = ["Alva","Johan","My","Leo","Sara","Mika","Noah","Ines"].map(n=>({name:n,alive:true}));
  const wolves=Math.max(1,Math.floor(state.players.length/5)); const pool=[];
  for(let i=0;i<wolves;i++) pool.push("varulv"); pool.push("sierska"); pool.push("jägare");
  while(pool.length<state.players.length) pool.push("bybo");
  shuffle(pool); state.players = state.players.map((p,i)=>({...p,roleId:pool[i]}));
  state.sceneIndex=0; state.phase="natt"; timerReset();
  save(); renderAll(); toast("demo laddad");
}
function exportJson(){
  const payload={state:{phase:state.phase,sceneIndex:state.sceneIndex,players:state.players,votes:state.votes,notes:state.notes}, data:state.data};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`janpire_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href);
}
function importJson(file){
  const r=new FileReader();
  r.onload=()=>{ try{
      const obj=JSON.parse(r.result);
      if(obj.data?.roles && obj.state?.players!==undefined){
        Object.assign(state,{...state,...obj.state}); state.data=obj.data; save(); renderAll(); toast("import ok");
      } else { toast("ogiltig json") }
    }catch{ toast("kunde inte läsa json") } };
  r.readAsText(file);
}

/* night wizard */
const steps=[
  {id:"blind", title:"alla blundar", body:"Alla blundar. Tystnad faller över byn."},
  {id:"wolves", title:"varulvarna vaknar", body:"Varulvarna öppnar ögonen och pekar ut ett offer. Bekräfta när du sett."},
  {id:"seer", title:"sierskan vaknar", body:"Sierskan pekar på en spelare. Viskande: ulv eller inte ulv."},
  {id:"others", title:"andra effekter", body:"Andra roller (om du lagt till dem) aktiveras."},
  {id:"dawn", title:"gryning", body:"Avslöja nattens konsekvenser. Byt fas till dag."}
];
let stepIdx=0;
function openWizard(){ stepIdx=0; renderWizard(); $("#overlay").classList.add("show"); $("#overlay").setAttribute("aria-hidden","false") }
function closeWizard(){ $("#overlay").classList.remove("show"); $("#overlay").setAttribute("aria-hidden","true") }
function renderWizard(){
  const row=$("#steps_row"); row.innerHTML="";
  steps.forEach((s,i)=>row.appendChild(el("span",{class:"step "+(i===stepIdx?"active":""),text:`${i+1}. ${s.title.toUpperCase()}`})));
  $("#step_body").innerHTML=`<p>${steps[stepIdx].body}</p>`;
  $("#overlay_prev").disabled = (stepIdx===0);
  $("#overlay_next").textContent = stepIdx===steps.length-1 ? "avsluta" : "nästa";
}

/* utils */
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j]]} return a }
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

/* bind */
function bind(){
  // phase & timer
  $("#btn_night").addEventListener("click",()=>setPhase("natt"));
  $("#btn_day").addEventListener("click",()=>setPhase("dag"));
  $("#timer_start").addEventListener("click",timerStart);
  $("#timer_stop").addEventListener("click",timerStop);
  $("#timer_reset").addEventListener("click",timerReset);

  // scenes
  $("#scene_next").addEventListener("click",()=>{ state.sceneIndex=Math.min(state.sceneIndex+1,state.data.story.scenes.length-1); save(); renderHeaderScene(); });
  $("#scene_repeat").addEventListener("click",()=>{ renderHeaderScene(); toast("scen repeterad"); });
  $("#scene_edit_current").addEventListener("click",()=>openSceneEditor(state.sceneIndex));
  $("#scene_new").addEventListener("click",()=>openSceneEditor(null));

  // scene modal
  $("#scene_save").addEventListener("click",saveSceneFromModal);
  $("#scene_delete").addEventListener("click",deleteSceneFromModal);
  $("#scene_duplicate").addEventListener("click",duplicateSceneFromModal);
  $("#scene_cancel").addEventListener("click",()=>showBackdrop(false));
  $("#scene_up").addEventListener("click",()=>moveSceneInModal(-1));
  $("#scene_down").addEventListener("click",()=>moveSceneInModal(1));

  // votes
  $("#vote_add_from_players").addEventListener("click",openCandidatePicker);
  $("#vote_clear").addEventListener("click",()=>{ state.votes={}; save(); renderVotes(); toast("röster rensade"); });
  $("#vote_result").addEventListener("click",()=>{
    const e=Object.entries(state.votes); if(e.length===0){ toast("inga röster"); return; }
    const s=e.sort((a,b)=>b[1]-a[1]); const top=s[0][1]; const winners=s.filter(([,c])=>c===top).map(([n])=>n);
    alert(`flest röster: ${winners.join(", ")} (${top})`);
  });

  // notes
  $("#notes").addEventListener("input",e=>{state.notes=e.target.value;save()});
  $("#notes_clear").addEventListener("click",()=>{$("#notes").value="";state.notes="";save()});

  // gm & settings
  $("#gm_toggle").addEventListener("click",toggleGM);
  $("#pin_input").addEventListener("change",e=>{state.pin=e.target.value.trim();toast("pin uppdaterad")});
  $("#hard_reset").addEventListener("click",()=>{ if(confirm("rensa allt och börja om?")){ localStorage.removeItem("janpire_state"); localStorage.removeItem("janpire_data"); location.reload(); }});
  $("#reset_btn").addEventListener("click",()=>{ if(confirm("nollställ spel (behåller story/roller)?")){ localStorage.removeItem("janpire_state"); location.reload(); }});

  // players
  $("#player_add").addEventListener("click",addPlayer);
  $("#player_bulk_add").addEventListener("click",addPlayersBulk);

  // roles
  $("#assign_roles").addEventListener("click",assignRoles);
  $("#clear_roles").addEventListener("click",clearRoles);

  // seed / import / export
  $("#seed_demo").addEventListener("click",seedDemo);
  $("#export_btn").addEventListener("click",exportJson);
  $("#import_file").addEventListener("change",e=>{ const f=e.target.files?.[0]; if(f) importJson(f) });

  // night overlay
  $("#night_wizard").addEventListener("click",openWizard);
  $("#overlay_close").addEventListener("click",closeWizard);
  $("#overlay_prev").addEventListener("click",()=>{ if(stepIdx>0){ stepIdx--; renderWizard(); }});
  $("#overlay_next").addEventListener("click",()=>{ if(stepIdx<steps.length-1){ stepIdx++; renderWizard(); } else { closeWizard(); setPhase("dag"); } });

  // keyboard
  document.addEventListener("keydown",e=>{
    if(e.key==="n") setPhase("natt");
    if(e.key==="d") setPhase("dag");
    if(e.key===" "){ e.preventDefault(); state.timerHandle?timerStop():timerStart(); }
  });
}

/* boot */
load();
if(state.sceneIndex>=state.data.story.scenes.length) state.sceneIndex=0;
renderAll(); bind();
if(!localStorage.getItem("janpire_booted")){ openGM(); localStorage.setItem("janpire_booted","1"); }

/* helpers */
function revealSecret(p){
  const role=state.data.roles.find(r=>r.id===p.roleId);
  const txt=role?`roll: ${role.name}\nlag: ${role.team}\n\nhemligt:\n${role.secret}`:"ingen roll utdelad än.";
  alert(`${p.name}\n\n${txt}`);
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j]]} return a }
</script>
</body>
</html>