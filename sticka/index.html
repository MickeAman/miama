<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stickräknare</title>

  <!-- appikon + manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <meta name="theme-color" content="#f7f7f5">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Stickräknare">
  <link rel="apple-touch-icon" href="icon-512.png">

  <!-- react + babel + tailwind + nosleep fallback -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/nosleep.js@0.12.0/dist/NoSleep.min.js"></script>

  <style>
    body {
      background: #f7f7f5;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: #1a1a1a;
      -webkit-tap-highlight-color: transparent;
    }
    input:focus, button:focus { outline: none; }
    .input-clear { position: absolute; right: .5rem; top: 50%; transform: translateY(-50%); background: transparent; border: 0; padding: .25rem; line-height: 1; cursor: pointer; color: #9ca3af; }
    .input-clear:hover { color: #4b5563; }
    .icon-btn {
      background: transparent; border: 0; cursor: pointer; color: #b0b0b0;
      font-size: 22px; font-weight: 300; padding: .25rem;
      transition: color 0.15s ease;
    }
    .icon-btn:hover { color: #404040; }
    .plus-btn {
      display:flex; align-items:center; justify-content:center;
      width:100%; padding:12px; border-radius:12px;
      background:transparent; color:#6b7280; /* muted gray */
      font-size:44px; font-weight:200;
      transition:color .2s ease, transform .1s ease;
    }
    .plus-btn:hover { color:#1f2937; }
    .plus-btn:active { transform:scale(.97); }
  </style>
</head>
<body>
  <div id="root" class="min-h-screen flex flex-col items-center justify-center p-6"></div>

  <script type="text/babel" data-presets="react,env">
    const { useState, useEffect, useRef } = React;
    const noSleep = new window.NoSleep();

    function Stickraknare() {
      const [count1, setCount1] = useState(() => parseInt(localStorage.getItem("stick-count1") || "0", 10));
      const [count2, setCount2] = useState(() => parseInt(localStorage.getItem("stick-count2") || "0", 10));
      const [name1, setName1]   = useState(() => localStorage.getItem("stick-name1") || "Räknare 1");
      const [name2, setName2]   = useState(() => localStorage.getItem("stick-name2") || "Räknare 2");
      const [keepAwake, setKeepAwake] = useState(() => localStorage.getItem("stick-keep-awake") === "true");
      const [showSecond, setShowSecond] = useState(() => localStorage.getItem("stick-hide-2") !== "true");

      const [extraCounters, setExtraCounters] = useState(() => {
        try {
          const raw = localStorage.getItem("stick-extra");
          const parsed = raw ? JSON.parse(raw) : [];
          return Array.isArray(parsed)
            ? parsed.map((it, idx) => ({
                id: it.id || `${Date.now()}-${idx}-${Math.random().toString(36).slice(2)}`,
                name: typeof it.name === "string" ? it.name : `Räknare ${idx + 3}`,
                count: Number.isFinite(it.count) ? it.count : 0
              }))
            : [];
        } catch { return []; }
      });

      const [wakeLock, setWakeLock] = useState(null);
      const [awakeStrategy, setAwakeStrategy] = useState("off");

      useEffect(() => localStorage.setItem("stick-count1", String(count1)), [count1]);
      useEffect(() => localStorage.setItem("stick-count2", String(count2)), [count2]);
      useEffect(() => localStorage.setItem("stick-name1", name1), [name1]);
      useEffect(() => localStorage.setItem("stick-name2", name2), [name2]);
      useEffect(() => localStorage.setItem("stick-keep-awake", String(keepAwake)), [keepAwake]);
      useEffect(() => localStorage.setItem("stick-hide-2", showSecond ? "false" : "true"), [showSecond]);
      useEffect(() => { localStorage.setItem("stick-extra", JSON.stringify(extraCounters)); }, [extraCounters]);

      useEffect(() => {
        if (keepAwake) enableKeepAwake();
        else disableKeepAwake();
        return () => disableKeepAwake();
      }, [keepAwake]);

      useEffect(() => {
        const onVis = async () => {
          if (document.visibilityState === "visible" && keepAwake) await enableKeepAwake(true);
        };
        document.addEventListener("visibilitychange", onVis);
        return () => document.removeEventListener("visibilitychange", onVis);
      }, [keepAwake]);

      async function enableKeepAwake(silent = false) {
        try {
          if ("wakeLock" in navigator && navigator.wakeLock?.request) {
            const lock = await navigator.wakeLock.request("screen");
            if (wakeLock?.release) { try { await wakeLock.release(); } catch(_){} }
            setWakeLock(lock);
            setAwakeStrategy("wakeLock");
            lock.addEventListener?.("release", () => {});
            return;
          }
        } catch (err) { if (!silent) console.log("wake lock fail:", err); }
        try { noSleep.enable(); setAwakeStrategy("noSleep"); }
        catch { setAwakeStrategy("off"); }
      }
      async function disableKeepAwake() {
        try { if (wakeLock?.release) await wakeLock.release(); } catch(_) {}
        setWakeLock(null);
        try { noSleep.disable(); } catch(_) {}
        setAwakeStrategy("off");
      }

      const CounterCard = ({ initialName, onCommitName, count, setCount, removable=false, onRemove }) => {
        const [localName, setLocalName] = useState(initialName);
        const inputRef = useRef(null);
        useEffect(() => { setLocalName(initialName); }, [initialName]);
        const commit = () => onCommitName((localName||"").trim() || initialName);
        const onKeyDown = e => { if(e.key==="Enter"){ e.preventDefault(); commit(); requestAnimationFrame(()=>inputRef.current?.focus()); } };
        const clearName = () => { setLocalName(""); requestAnimationFrame(()=>inputRef.current?.focus()); };

        return (
          <div className="relative bg-white rounded-2xl shadow-sm p-6 border border-stone-200">
            {removable && (
              <button type="button" title="Ta bort" className="icon-btn absolute right-3 top-3" onClick={onRemove}>×</button>
            )}
            <div className="relative">
              <input ref={inputRef} type="text" value={localName}
                onChange={e=>setLocalName(e.target.value)} onBlur={commit} onKeyDown={onKeyDown}
                className="text-xl font-semibold mb-3 w-full text-center bg-transparent border-b border-stone-300 focus:border-stone-500"
                placeholder="Namn på räknare"/>
              {localName && <button type="button" aria-label="Rensa namn" className="input-clear" onClick={clearName}>×</button>}
            </div>
            <div className="text-6xl font-light mb-6 text-stone-900">{count}</div>
            <button onClick={()=>setCount(count+1)}
              className="w-full bg-stone-900 text-white py-4 rounded-lg text-lg tracking-wide transition-all hover:bg-stone-800 active:scale-95">
              Lägg till varv
            </button>
            <div className="flex justify-between mt-4 gap-2">
              <button onClick={()=>setCount(Math.max(0,count-1))}
                className="flex-1 bg-white border border-stone-300 text-stone-700 py-3 rounded-lg text-sm hover:bg-stone-100 active:scale-95 transition">Ångra</button>
              <button onClick={()=>setCount(0)}
                className="flex-1 bg-white border border-stone-300 text-stone-700 py-3 rounded-lg text-sm hover:bg-stone-100 active:scale-95 transition">Nollställ</button>
            </div>
          </div>
        );
      };

      const addExtraCounter = () => {
        const nextIndex = 3 + extraCounters.length + (showSecond ? 0 : 1);
        const id = `${Date.now()}-${Math.random().toString(36).slice(2)}`;
        setExtraCounters([...extraCounters, { id, name:`Räknare ${nextIndex}`, count:0 }]);
      };
      const updateExtra = (id, patch) => setExtraCounters(ec=>ec.map(c=>c.id===id?{...c,...patch}:c));
      const removeExtra = id => setExtraCounters(ec=>ec.filter(c=>c.id!==id));

      return (
        <main className="max-w-md w-full space-y-6">
          <header className="text-center">
            <h1 className="text-3xl font-semibold mb-2">Stickräknare</h1>
            <p className="text-stone-500 text-sm">Håll koll på dina varv</p>
          </header>

          <div className="flex items-center justify-center gap-2">
            <input id="keep-awake" type="checkbox" checked={keepAwake}
              onChange={e=>setKeepAwake(e.target.checked)} className="w-5 h-5 accent-stone-700 cursor-pointer"/>
            <label htmlFor="keep-awake" className="text-stone-600 text-sm select-none">Håll skärmen vaken</label>
          </div>
          <p className="text-center text-xs text-stone-500 -mt-3">
            Status: {awakeStrategy==="wakeLock"?"Skärmlås aktivt (Wake Lock)":awakeStrategy==="noSleep"?"Skärmlås via NoSleep":"Av"}
          </p>

          <CounterCard initialName={name1} onCommitName={setName1} count={count1} setCount={setCount1}/>
          {showSecond && (
            <CounterCard initialName={name2} onCommitName={setName2} count={count2} setCount={setCount2}
              removable onRemove={()=>setShowSecond(false)}/>
          )}
          {extraCounters.map(c=>(
            <CounterCard key={c.id} initialName={c.name}
              onCommitName={v=>updateExtra(c.id,{name:v})}
              count={c.count} setCount={v=>updateExtra(c.id,{count:typeof v==="function"?v(c.count):v})}
              removable onRemove={()=>removeExtra(c.id)}/>
          ))}

          <button className="plus-btn" onClick={addExtraCounter} aria-label="Lägg till ny räknare">＋</button>

          <footer className="text-center text-xs text-stone-400 pt-4 pb-2">
            gjord med ♥ i sverige
          </footer>
        </main>
      );
    }

    ReactDOM.render(<Stickraknare />, document.getElementById("root"));
  </script>
</body>
</html>